<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MB Bot Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        @keyframes pulse-green {
            0% {
                background-color: rgba(74, 222, 128, 0.1);
            }
            50% {
                background-color: rgba(74, 222, 128, 0.3);
            }
            100% {
                background-color: rgba(74, 222, 128, 0.1);
            }
        }

        @keyframes pulse-orange {
            0% {
                background-color: rgba(251, 146, 60, 0.1);
            }
            50% {
                background-color: rgba(251, 146, 60, 0.3);
            }
            100% {
                background-color: rgba(251, 146, 60, 0.1);
            }
        }

        .pulse-green {
            animation: pulse-green 2s infinite;
        }

        .pulse-orange {
            animation: pulse-orange 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">
<div class="container mx-auto p-4">
    <div class="flex justify-between items-center mb-4">
        <h1 class="text-xl sm:text-2xl font-bold">üìä MB Bot Dashboard</h1>
        <span id="mode" class="px-2 py-1 sm:px-3 sm:py-1 bg-green-600 rounded-full text-xs sm:text-sm">Modo: Live</span>
    </div>
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow border-l-4 border-blue-500">
            <p class="text-gray-400 text-xs sm:text-sm">√öltimo Pre√ßo</p>
            <h2 id="lastPrice" class="text-lg sm:text-xl font-bold">Carregando...</h2>
            <p id="bidAsk" class="text-xs sm:text-sm text-gray-400">Bid: -- | Ask: --</p>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow border-l-4 border-yellow-500">
            <p class="text-gray-400 text-xs sm:text-sm">Spread / Volatilidade</p>
            <h2 id="spread" class="text-lg sm:text-xl font-bold">--</h2>
            <p id="volatility" class="text-xs sm:text-sm text-gray-400">Vol: --</p>
        </div>
        <div id="pnlCard" class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow border-l-4 border-gray-500">
            <p class="text-gray-400 text-xs sm:text-sm">Lucro/Prejuizo Total (PnL)</p>
            <h2 id="pnl" class="text-lg sm:text-xl font-bold">R$ 0,00</h2>
            <p id="pnlStatus" class="text-xs sm:text-sm text-gray-400">Resultado: Neutro</p>
            <p id="roiCard" class="text-xs sm:text-sm text-gray-400">ROI: 0,00%</p>
            <p id="roiBase" class="text-xs text-gray-500">Base ROI: R$ 0,00</p>
            <p id="netContrib" class="text-xs text-gray-500">Aportes liquido: R$ 0,00</p>
            <div class="mt-2 flex flex-col gap-2">
                <div class="flex flex-wrap gap-2">
                    <input id="contribAmount" type="number" min="0" step="0.01" placeholder="Valor (R$)"
                        class="w-28 sm:w-32 text-xs bg-gray-900 border border-gray-700 rounded px-2 py-1 text-gray-200" />
                    <input id="contribNote" type="text" maxlength="120" placeholder="Obs (opcional)"
                        class="flex-1 min-w-[120px] text-xs bg-gray-900 border border-gray-700 rounded px-2 py-1 text-gray-200" />
                </div>
                <div class="flex gap-2">
                    <button id="contribAddBtn" onclick="submitContribution('deposit')"
                        class="text-xs px-2 py-1 bg-green-700 hover:bg-green-600 rounded text-white">Aportar</button>
                    <button id="contribWithdrawBtn" onclick="submitContribution('withdraw')"
                        class="text-xs px-2 py-1 bg-red-700 hover:bg-red-600 rounded text-white">Retirar</button>
                </div>
            </div>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow border-l-4 border-purple-500">
            <p class="text-gray-400 text-xs sm:text-sm">Saldo Total Est.</p>
            <h2 id="totalBalanceCard" class="text-lg sm:text-xl font-bold">Carregando...</h2>
            <p id="monthlyPnl" class="text-xs sm:text-sm text-gray-400">Mensal: R$ 0,00</p>
        </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-2">Saldos</h2>
            <ul class="space-y-1 text-xs sm:text-sm">
                <li>BRL: <span id="brl">Carregando...</span></li>
                <li>BTC: <span id="btc">Carregando...</span></li>
                <li>Total: <span id="totalBalanceList">Carregando...</span></li>
            </ul>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow md:col-span-3">
            <h2 class="text-base sm:text-lg font-bold mb-2">Ordens Ativas</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-xs sm:text-sm">
                    <thead>
                    <tr class="text-gray-400">
                        <th class="text-left p-1 sm:p-2">Side</th>
                        <th class="text-left p-1 sm:p-2">ID</th>
                        <th class="text-left p-1 sm:p-2">Pair ID</th>
                        <th class="text-left p-1 sm:p-2">Pre√ßo</th>
                        <th class="text-left p-1 sm:p-2">Qtd</th>
                        <th class="text-left p-1 sm:p-2">Status</th>
                        <th class="text-left p-1 sm:p-2">Exchange</th>
                        <th class="text-left p-1 sm:p-2">Drift</th>
                        <th class="text-left p-1 sm:p-2">Age</th>
                    </tr>
                    </thead>
                    <tbody id="ordersTable">
                    <tr>
                        <td class="text-red-400 p-1 sm:p-2">sell</td>
                        <td class="p-1 sm:p-2">01K70C1BRYAXM0PD92BRESXN7A</td>
                        <td class="p-1 sm:p-2">R$ 655.532,00</td>
                        <td class="p-1 sm:p-2">0.000020</td>
                        <td class="p-1 sm:p-2">working</td>
                        <td class="p-1 sm:p-2">0.05%</td>
                        <td class="p-1 sm:p-2">00:04:19</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- SE√á√ÉO DE PARES BUY/SELL -->
    <div class="mt-4 bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
        <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
            <h2 class="text-base sm:text-lg font-bold">üîó Rastreamento de Pares BUY/SELL</h2>
            <div class="flex gap-2 items-center">
                <span id="pairsRefreshBadge" class="text-xs px-2 py-1 bg-gray-700 rounded text-gray-300">Atualizando...</span>
                <button id="toggleCompletePairsBtn" onclick="toggleCompletePairs()"
                    class="text-xs px-3 py-1 bg-blue-700 hover:bg-blue-600 rounded text-white transition"
                    title="Exibir apenas ciclos completos">
                    ‚úÖ Completos
                </button>
                <button id="downloadPairsBtn" onclick="downloadPairsJson()"
                    class="text-xs px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-white transition"
                    title="Baixar JSON com todos os pares">
                    ‚¨áÔ∏è JSON
                </button>
                <button id="clearAllOrdersBtn" onclick="clearAllOrders()" 
                    class="text-xs px-3 py-1 bg-red-700 hover:bg-red-600 rounded text-white transition"
                    title="Cancelar TODAS as ordens abertas do sistema">
                    üö® Limpar Todas
                </button>
            </div>
        </div>
        
        <!-- Resumo de Pares -->
        <div class="grid grid-cols-1 sm:grid-cols-4 gap-2 mb-4">
            <div class="bg-gray-700 p-3 rounded-lg text-center">
                <div class="text-2xl font-bold text-blue-400" id="totalPairsCount">0</div>
                <div class="text-xs text-gray-400 mt-1">Total de Pares</div>
            </div>
            <div class="bg-gray-700 p-3 rounded-lg text-center">
                <div class="text-2xl font-bold text-green-400" id="completePairsCount">0</div>
                <div class="text-xs text-gray-400 mt-1">Pares Completos</div>
            </div>
            <div class="bg-gray-700 p-3 rounded-lg text-center">
                <div class="text-2xl font-bold text-yellow-400" id="incompletePairsCount">0</div>
                <div class="text-xs text-gray-400 mt-1">Incompletos</div>
            </div>
            <div class="bg-gray-700 p-3 rounded-lg text-center">
                <div class="text-2xl font-bold text-orange-400" id="avgPairRoi">0.00%</div>
                <div class="text-xs text-gray-400 mt-1">ROI M√©dio</div>
            </div>
        </div>

        <!-- Tabela de Pares -->
        <div class="overflow-x-auto max-h-96 overflow-y-auto">
            <table class="w-full text-xs">
                <thead>
                <tr class="text-gray-400 border-b border-gray-700">
                    <th class="text-left p-2">Pair ID</th>
                    <th class="text-left p-2">Status</th>
                    <th class="text-center p-2">BUY<br><span class="text-xs text-gray-500">(Pre√ßo / Execu√ß√£o)</span></th>
                    <th class="text-center p-2">SELL<br><span class="text-xs text-gray-500">(Pre√ßo / Execu√ß√£o)</span></th>
                    <th class="text-right p-2">Spread</th>
                    <th class="text-right p-2">ROI L√≠quido</th>
                    <th class="text-center p-2">Ciclo</th>
                    <th class="text-center p-2">A√ß√µes</th>
                </tr>
                </thead>
                <tbody id="pairsTableBody">
                <tr>
                    <td class="p-2 text-gray-400 text-center" colspan="8">Carregando pares...</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- SE√á√ÉO DE TESTES AUTOMATIZADOS -->
    <div class="mt-4 bg-gray-800 p-2 sm:p-4 rounded-xl shadow" id="testsSection">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-base sm:text-lg font-bold" style="color: #f59e0b;">üß™ Testes Automatizados (Dados Reais)</h2>
            <div class="flex gap-2 items-center">
                <span id="testsStatus" class="text-xs px-2 py-1 bg-gray-700 rounded text-gray-300">Carregando...</span>
                <button id="runTestsBtn" onclick="runAutomatedTests()" 
                    class="text-xs px-3 py-1 bg-yellow-600 hover:bg-yellow-500 rounded text-white transition disabled:opacity-50 disabled:cursor-not-allowed">
                    üîÑ Refazer Testes (24h)
                </button>
            </div>
        </div>
        
        <!-- Resumo dos Testes -->
        <div class="grid grid-cols-2 sm:grid-cols-5 gap-2 mb-4" id="testsSummary">
            <div class="bg-gray-700 p-3 rounded-lg text-center">
                <div class="text-2xl font-bold text-blue-400" id="testsTotal">-</div>
                <div class="text-xs text-gray-400 mt-1">Total de Testes</div>
            </div>
            <div class="bg-gray-700 p-3 rounded-lg text-center">
                <div class="text-2xl font-bold text-green-400" id="testsPassed">-</div>
                <div class="text-xs text-gray-400 mt-1">Passaram ‚úÖ</div>
            </div>
            <div class="bg-gray-700 p-3 rounded-lg text-center">
                <div class="text-2xl font-bold text-red-400" id="testsFailed">-</div>
                <div class="text-xs text-gray-400 mt-1">Falharam ‚ùå</div>
            </div>
            <div class="bg-gray-700 p-3 rounded-lg text-center">
                <div class="text-2xl font-bold text-yellow-400" id="testsPassRate">-%</div>
                <div class="text-xs text-gray-400 mt-1">Taxa de Sucesso</div>
            </div>
            <div class="bg-gray-700 p-3 rounded-lg text-center">
                <div class="text-lg font-bold text-purple-400" id="testsDataSource">-</div>
                <div class="text-xs text-gray-400 mt-1">Fonte de Dados</div>
            </div>
        </div>

        <!-- üí∞ PROJE√á√ÉO DE GANHOS (NOVO) -->
        <div class="bg-gradient-to-r from-gray-700 to-gray-800 p-4 rounded-lg mb-4 border border-gray-600" id="projectionSection">
            <h3 class="text-sm font-bold text-yellow-400 mb-3">üí∞ PROJE√á√ÉO DE GANHOS - <span id="bestTestName">Melhor Teste</span></h3>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                <div class="bg-gray-900 p-3 rounded text-center">
                    <div class="text-xs text-gray-400 mb-1">PnL no Teste</div>
                    <div class="text-xl font-bold" id="projPnlTest">-</div>
                </div>
                <div class="bg-gray-900 p-3 rounded text-center">
                    <div class="text-xs text-gray-400 mb-1">vs HOLD</div>
                    <div class="text-xl font-bold" id="projVsHold">-</div>
                </div>
                <div class="bg-gray-900 p-3 rounded text-center">
                    <div class="text-xs text-gray-400 mb-1">üìÖ Proje√ß√£o Mensal</div>
                    <div class="text-xl font-bold" id="projMonthly">-</div>
                    <div class="text-xs text-gray-500" id="projMonthlyRoi">-</div>
                </div>
                <div class="bg-gray-900 p-3 rounded text-center">
                    <div class="text-xs text-gray-400 mb-1">üìÜ Proje√ß√£o Anual</div>
                    <div class="text-xl font-bold" id="projYearly">-</div>
                    <div class="text-xs text-gray-500" id="projYearlyRoi">-</div>
                </div>
            </div>
            <div class="mt-3 text-xs text-gray-500 text-center">
                <span id="projDisclaimer">‚ö†Ô∏è Proje√ß√µes baseadas em <span id="projHours">-</span>h de dados hist√≥ricos. Resultados passados n√£o garantem retornos futuros.</span>
            </div>
        </div>

        <!-- Info do Per√≠odo de Dados -->
        <div class="bg-gray-700 p-3 rounded-lg mb-4" id="testsPriceInfo">
            <div class="grid grid-cols-2 sm:grid-cols-5 gap-2 text-xs">
                <div>
                    <span class="text-gray-400">Per√≠odo:</span>
                    <span id="testsHours" class="text-white font-bold">-</span>
                </div>
                <div>
                    <span class="text-gray-400">Pre√ßo Inicial:</span>
                    <span id="testsPriceStart" class="text-white">-</span>
                </div>
                <div>
                    <span class="text-gray-400">Pre√ßo Final:</span>
                    <span id="testsPriceEnd" class="text-white">-</span>
                </div>
                <div>
                    <span class="text-gray-400">Varia√ß√£o:</span>
                    <span id="testsPriceChange" class="text-white">-</span>
                </div>
                <div>
                    <span class="text-gray-400">Data Points:</span>
                    <span id="testsDataPoints" class="text-white">-</span>
                </div>
            </div>
        </div>

        <!-- Tabela de Resultados dos Testes -->
        <div class="overflow-x-auto">
            <table class="w-full text-xs">
                <thead>
                <tr class="text-gray-400 border-b border-gray-700">
                    <th class="text-left p-2">Teste</th>
                    <th class="text-center p-2">Status</th>
                    <th class="text-right p-2">PnL (R$)</th>
                    <th class="text-right p-2">vs HOLD</th>
                    <th class="text-right p-2">ROI</th>
                    <th class="text-right p-2">BTC Ganho</th>
                    <th class="text-right p-2">Proj. Mensal</th>
                </tr>
                </thead>
                <tbody id="testsTableBody">
                <tr>
                    <td class="p-2 text-gray-400 text-center" colspan="7">Aguardando resultados dos testes...</td>
                </tr>
                </tbody>
            </table>
        </div>
        
        <!-- √öltima Execu√ß√£o -->
        <div class="mt-3 text-xs text-gray-500 flex justify-between">
            <span>√öltima execu√ß√£o: <span id="testsLastRun">-</span></span>
            <span>Cache: <span id="testsCacheAge">-</span></span>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
        <!-- Gr√°fico de PnL -->
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-2" style="color: #10b981;">üìà Evolu√ß√£o do PnL (R$)</h2>
            <div class="w-full h-64 sm:h-72">
                <canvas id="pnlChart"></canvas>
            </div>
        </div>
        
        <!-- Gr√°fico de BTC Price -->
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-2" style="color: #3b82f6;">üí∞ Pre√ßo BTC (R$)</h2>
            <div class="w-full h-64 sm:h-72">
                <canvas id="btcChart"></canvas>
            </div>
        </div>
        
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow" id="recoveryMonitorContainer" style="display:none;">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <h2 class="text-base sm:text-lg font-bold" style="color: #fbbf24;">Monitor de Recupera√ß√£o (PnL Residual)</h2>
                    <span id="baselineBadge" class="hidden text-xs px-2 py-1 rounded-full bg-yellow-700 text-yellow-200">Baseline atualizado</span>
                </div>
                <button id="resetBaselineBtn" class="text-xs px-2 py-1 bg-gray-600 hover:bg-gray-500 rounded text-gray-300 transition" title="Resetar ponto de refer√™ncia">‚Üª Reset</button>
            </div>
            
            <!-- Barra de Progresso para Meta -->
            <div class="mb-4 p-3 bg-gray-700 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-semibold text-gray-300">Progresso para Break-Even:</span>
                    <span id="recoveryPercentage" class="text-lg font-bold text-yellow-400">0%</span>
                </div>
                <div class="w-full bg-gray-600 rounded-full h-6 overflow-hidden">
                    <div id="recoveryProgressBar" class="bg-gradient-to-r from-red-500 to-yellow-400 h-6 rounded-full transition-all duration-500" style="width: 0%;">
                        <span id="recoveryProgressText" class="absolute ml-2 text-xs font-bold text-gray-900 h-6 flex items-center" style="display: none;">0%</span>
                    </div>
                </div>
                <div class="flex justify-between text-xs text-gray-400 mt-2">
                    <span>Perda Atual: <strong id="recoveryLoss">-R$ 5,34</strong></span>
                    <span>Meta: <strong>R$ 0,00</strong></span>
                </div>
                <div class="text-xs text-gray-500 mt-1">
                    <span>Baseline: <strong id="recoveryBaseline">-R$ 5,34</strong></span>
                </div>
            </div>
            
            <div class="w-full h-64 sm:h-72">
                <canvas id="residualPnlChart"></canvas>
            </div>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-4">Config & Tend√™ncia</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <h3 class="text-sm font-semibold mb-2 text-gray-300">Configura√ß√µes do Bot</h3>
                    <ul class="space-y-1 text-xs sm:text-sm">
                        <li title="Tamanho m√≠nimo de cada ordem em BTC" class="p-1 rounded pulse-green">
                            Ordem size: <span id="orderSize">0.00005 BTC (~R$ 32,75)</span>
                        </li>
                        <li title="Percentual alvo de diferen√ßa entre compra e venda" class="p-1 rounded pulse-green">
                            Spread alvo: <span id="targetSpread">0.02% ‚úÖ</span>
                        </li>
                        <li title="Intervalo entre ciclos de decis√£o do bot" class="p-1 rounded">
                            Intervalo ciclo: <span id="cycleSec">15s</span>
                        </li>
                        <li title="Limite de perda para cancelar ordens" class="p-1 rounded">
                            Stop-Loss: <span id="stopLoss">0.80%</span>
                        </li>
                        <li title="Meta de lucro para realizar ganhos" class="p-1 rounded">
                            Take-Profit: <span id="takeProfit">2.00%</span>
                        </li>
                        <li title="Volume m√≠nimo para ordens serem v√°lidas" class="p-1 rounded">
                            Volume M√≠nimo: <span id="minVolume">0.00005 BTC</span>
                        </li>
                        <li title="Limite m√°ximo de volatilidade para operar" class="p-1 rounded">
                            Limite de Volatilidade: <span id="volatilityLimit">3.50%</span>
                        </li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold mb-2 text-gray-300">Indicadores T√©cnicos</h3>
                    <ul class="space-y-1 text-xs sm:text-sm">
                        <li title="Tend√™ncia do mercado com base em indicadores" class="p-1 rounded">
                                    Tend√™ncia: <span id="trend">Neutra ‚û°Ô∏è - R$ 654.973,00</span>
                        </li>
                        <li title="Regime de mercado atual" class="p-1 rounded">
                            Regime: <span id="regime" class="font-bold">NEUTRAL</span>
                        </li>     </li>
                        <li title="√çndice de For√ßa Relativa (0-100, <30 sobrevendido, >70 sobrecomprado)"
                            class="p-1 rounded">
                            RSI: <span id="rsi">33.22 ‚úÖ</span>
                        </li>
                        <li title="M√©dia M√≥vel Exponencial de curto prazo (8 per√≠odos)" class="p-1 rounded">
                            EMA Curta: <span id="emaShort">R$ 655.200,77</span>
                        </li>
                        <li title="M√©dia M√≥vel Exponencial de longo prazo (20 per√≠odos)" class="p-1 rounded">
                            EMA Longa: <span id="emaLong">R$ 655.031,24</span>
                        </li>
                        <li title="Diferen√ßa entre EMAs de 12 e 26 per√≠odos" class="p-1 rounded">
                            MACD: <span id="macd">382.09</span>
                        </li>
                        <li title="M√©dia M√≥vel do MACD (9 per√≠odos)" class="p-1 rounded pulse-green">
                            Signal: <span id="signal">382.09 ‚úÖ</span>
                        </li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold mb-2 text-gray-300">Valida√ß√£o Externa üì°</h3>
                    <ul class="space-y-1 text-xs sm:text-sm">
                        <li title="Alinhamento entre an√°lise do bot e tend√™ncias externas" id="alignmentStatus" class="p-1 rounded">
                            Status: <span id="alignment">Carregando...</span>
                        </li>
                        <li title="Tend√™ncia calculada por fontes externas" class="p-1 rounded">
                            Tend√™ncia Externa: <span id="externalTrend">--</span>
                        </li>
                        <li title="Confian√ßa da an√°lise externa (0 a 1)" class="p-1 rounded">
                            Confian√ßa Externa: <span id="externalConfidence">--</span>
                        </li>
                        <li title="Score da tend√™ncia externa (-1 a 1)" class="p-1 rounded">
                            Score: <span id="externalScore">--</span>
                        </li>
                        <li title="Status das fontes de dados externas" class="p-1 rounded">
                            Fontes: <span id="externalSources">--</span>
                        </li>
                        <li title="Compara√ß√£o das an√°lises Bot vs External" class="p-1 rounded">
                            Bot vs Externo: <span id="botVsExternal">--</span>
                        </li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold mb-2 text-gray-300">Vi√©s e Performance</h3>
                    <ul class="space-y-1 text-xs sm:text-sm">
                        <li title="Probabilidade de lucro estimada (0 a 1)" class="p-1 rounded pulse-green">
                            Score Lucro Esperado: <span id="expectedProfitScore">1.00 ‚úÖ</span>
                        </li>
                        <li title="Confian√ßa na previs√£o de tend√™ncia (0 a 1)" class="p-1 rounded pulse-green">
                            Confian√ßa: <span id="confidence">1.00 ‚úÖ</span>
                        </li>
                        <li title="Ajuste de pre√ßo com base no saldo de BTC" class="p-1 rounded">
                            Vi√©s Invent√°rio: <span id="inventoryBias">0.000013</span>
                        </li>
                        <li title="Ajuste de pre√ßo com base na tend√™ncia do mercado" class="p-1 rounded">
                            Vi√©s Tend√™ncia: <span id="trendBias">-0.026300</span>
                        </li>
                        <li title="Combina√ß√£o de vi√©s de invent√°rio e tend√™ncia" class="p-1 rounded">
                            Total Bias: <span id="totalBias">-0.010000</span>
                        </li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold mb-2 text-gray-300">Posi√ß√£o e Resultados</h3>
                    <ul class="space-y-1 text-xs sm:text-sm">
                        <li title="Lucro/preju√≠zo n√£o realizado da posi√ß√£o atual" class="p-1 rounded">
                            PnL N√£o Realizado: <span id="unrealizedPnl">R$ 0.00 üòê</span>
                        </li>
                        <li title="Lucro/preju√≠zo realizado (apenas SELL executadas)" class="p-1 rounded">
                            PnL Realizado: <span id="realizedPnl">R$ 0.00 üòê</span>
                        </li>
                        <li title="Quantidade de BTC em posi√ß√£o" class="p-1 rounded">
                            Posi√ß√£o BTC: <span id="btcPosition">0.00002000 BTC</span>
                        </li>
                        <li title="Percentual de ordens executadas com sucesso" class="p-1 rounded pulse-green">
                            Taxa de Fill: <span id="fillRate">24.0% ‚úÖ</span>
                        </li>
                        <li title="Pre√ßo m√©dio das ordens executadas" class="p-1 rounded">
                            Pre√ßo M√©dio Fill: <span id="avgFillPrice">R$ 654.259,13</span>
                        </li>
                        <li title="Tempo de atividade do bot" class="p-1 rounded pulse-green">
                            Uptime: <span id="uptime">23 minutos</span>
                        </li>
                        <li title="Retorno sobre investimento (ROI)" class="p-1 rounded pulse-green">
                            ROI: <span id="roiList">0.01% üìà</span>
                        </li>
                        <li title="Aportes e retiradas registrados no dashboard" class="p-1 rounded">
                            Aportes liquido: <span id="netContribList">R$ 0.00</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const priceHistory = [];
    let pnlChart;
    let btcChart;
    let residualPnlChart;
    let showCompletedPairs = false;
    let latestPairsData = null;

    document.addEventListener('DOMContentLoaded', () => {
        console.log('[Dashboard] üîß Initializing charts...');
        // Gr√°fico de PnL (apenas linha verde do PnL)
        pnlChart = new Chart(document.getElementById('pnlChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: "PnL (R$)",
                        borderColor: "#10b981",
                        backgroundColor: "rgba(16,185,129,0.1)",
                        borderWidth: 2.5,
                        fill: true,
                        data: [],
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointBackgroundColor: "#10b981",
                        pointBorderColor: "#ffffff",
                        pointBorderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {mode: 'index', intersect: false},
                plugins: {
                    legend: {display: true, position: 'top', labels: {color: '#9ca3af', font: {size: 11}}},
                    tooltip: {
                        backgroundColor: 'rgba(17, 24, 39, 0.9)',
                        titleColor: '#f3f4f6',
                        bodyColor: '#d1d5db',
                        borderColor: '#10b981',
                        borderWidth: 2,
                        padding: 10,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) {
                                    const value = context.parsed.y;
                                    const color = value >= 0 ? '#10b981' : '#ef4444';
                                    label += (value >= 0 ? '+' : '') + 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        position: 'right',
                        title: {display: true, text: 'PnL (R$)', color: '#10b981', font: {weight: 'bold'}},
                        grid: {color: 'rgba(75, 85, 99, 0.1)'},
                        ticks: {color: '#9ca3af', font: {size: 11}, callback: function(value) {
                            return (value >= 0 ? '+' : '') + 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        }}
                    },
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            displayFormats: {minute: 'HH:mm'}
                        },
                        grid: {color: 'rgba(75, 85, 99, 0.1)'},
                        ticks: {color: '#9ca3af', font: {size: 10}}
                    }
                }
            }
        });

        // Gr√°fico de BTC Price (apenas linha azul do pre√ßo)
        btcChart = new Chart(document.getElementById('btcChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: "BTC Price (R$)",
                        borderColor: "#3b82f6",
                        backgroundColor: "rgba(59,130,246,0.1)",
                        borderWidth: 2.5,
                        fill: true,
                        data: [],
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointBackgroundColor: "#3b82f6",
                        pointBorderColor: "#ffffff",
                        pointBorderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {mode: 'index', intersect: false},
                plugins: {
                    legend: {display: true, position: 'top', labels: {color: '#9ca3af', font: {size: 11}}},
                    tooltip: {
                        backgroundColor: 'rgba(17, 24, 39, 0.9)',
                        titleColor: '#f3f4f6',
                        bodyColor: '#d1d5db',
                        borderColor: '#3b82f6',
                        borderWidth: 2,
                        padding: 10,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) {
                                    label += 'R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        position: 'right',
                        title: {display: true, text: 'BTC Price (R$)', color: '#3b82f6', font: {weight: 'bold'}},
                        grid: {color: 'rgba(75, 85, 99, 0.1)'},
                        ticks: {color: '#9ca3af', font: {size: 11}, callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        }}
                    },
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            displayFormats: {minute: 'HH:mm'}
                        },
                        grid: {color: 'rgba(75, 85, 99, 0.1)'},
                        ticks: {color: '#9ca3af', font: {size: 10}}
                    }
                }
            }
        });
        console.log('[Dashboard] ‚úÖ Charts initialized:', { pnlChart: !!pnlChart, btcChart: !!btcChart });
    });

    function formatSpread(spread) {
        if (!spread && spread !== 0) return "Sem dados";
        const num = Number(spread) || 0;
        if (!isFinite(num)) return "Sem dados";
        const value = num.toFixed(2);
        let level = "";
        if (num < 0.5) level = " (muito baixo) ‚úÖ";
        else if (num < 1.5) level = " (moderado) üòê";
        else level = " (alto) ‚ö†Ô∏è";
        return `${value}%${level}`;
    }

    function formatVolatility(vol) {
        if (!vol && vol !== 0) return "Sem dados";
        const num = Number(vol) || 0;
        if (!isFinite(num)) return "Sem dados";
        const value = num.toFixed(2);
        let desc = "";
        if (num < 0.5) desc = " (est√°vel) ‚úÖ";
        else if (num < 1.5) desc = " (moderada) üòê";
        else desc = " (alta) ‚ö†Ô∏è";
        return `${value}%${desc}`;
    }

    // Fun√ß√£o global de formata√ß√£o segura
    window.safeBRFormat = function(value, decimals = 2) {
        const num = parseFloat(value) || 0;
        if (!isFinite(num)) return '-';
        if (decimals === 0) {
            return num.toLocaleString('pt-BR', {maximumFractionDigits: 0});
        }
        return num.toLocaleString('pt-BR', {minimumFractionDigits: decimals, maximumFractionDigits: decimals});
    };

    function formatHms(totalSeconds) {
        const safeSeconds = Math.max(0, Math.floor(totalSeconds || 0));
        const hours = Math.floor(safeSeconds / 3600);
        const minutes = Math.floor((safeSeconds % 3600) / 60);
        const seconds = safeSeconds % 60;
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    async function loadData(forceRefresh = false) {
        try {
            console.log('[Dashboard] Fetching data from API...');
            const refreshParam = forceRefresh ? '&refresh=true' : '';
            const res = await fetch(`/api/data?t=${Date.now()}${refreshParam}`);
            
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            
            const data = await res.json();
            console.log('[Dashboard] ‚úÖ Data loaded successfully');
            
            // Debug: mostrar dados recebidos
            console.log('[Dashboard] Raw data:', data);
            console.log('[Dashboard] Data loaded:', {
                roi: data.stats?.roi,
                totalPnL: data.stats?.totalPnL || data.stats?.pnl_total,
                balanceTotal: data.balance?.total
            });

            // Fun√ß√£o auxiliar para safe formatting
            const safeFormat = (value, decimals = 2) => {
                try {
                    const num = parseFloat(value) || 0;
                    if (!isFinite(num)) return '-';
                    if (decimals === 0) {
                        return num.toLocaleString('pt-BR', {maximumFractionDigits: 0});
                    }
                    return num.toLocaleString('pt-BR', {minimumFractionDigits: decimals, maximumFractionDigits: decimals});
                } catch (e) {
                    console.warn('[Dashboard] Format error:', e.message, 'Value:', value);
                    return '-';
                }
            };

            const modeSpan = document.getElementById('mode');
            if (modeSpan) {
                modeSpan.textContent = `Modo: ${data.config?.simulate ? 'Simula√ß√£o' : 'Live'}`;
                modeSpan.className = data.config?.simulate
                    ? 'px-2 py-1 sm:px-3 sm:py-1 bg-yellow-600 rounded-full text-xs sm:text-sm'
                    : 'px-2 py-1 sm:px-3 sm:py-1 bg-green-600 rounded-full text-xs sm:text-sm';
            }

            const lastPrice = parseFloat(data.market?.last) || parseFloat(data.market?.mid) || 654973.00;
            const lastPriceEl = document.getElementById('lastPrice');
            if (lastPriceEl) {
                lastPriceEl.textContent = `R$ ${safeFormat(lastPrice, 2)}`;
            }

            const bidAskEl = document.getElementById('bidAsk');
            if (bidAskEl) {
                const bid = parseFloat(data.market?.bid || 0);
                const ask = parseFloat(data.market?.ask || 0);
                const bidText = bid > 0 ? `R$ ${safeFormat(bid, 2)}` : '--';
                const askText = ask > 0 ? `R$ ${safeFormat(ask, 2)}` : '--';
                bidAskEl.textContent = `Bid: ${bidText} | Ask: ${askText}`;
            }

            const spread = parseFloat(data.market?.spread || 0.06);
            const spreadEl = document.getElementById('spread');
            if (spreadEl) {
                spreadEl.textContent = isFinite(spread) ? `${spread.toFixed(2)}%` : '-';
            }
            
            const volatility = parseFloat(data.market?.volatility || data.market?.tendency?.volatility || 0.26);
            const volatilityEl = document.getElementById('volatility');
            if (volatilityEl) {
                volatilityEl.textContent = isFinite(volatility) ? `${volatility.toFixed(2)}%` : '-';
            }

            const totalPnL = parseFloat(data.stats?.totalPnL || data.stats?.pnl_total || 0);
            const realizedPnL = parseFloat(data.stats?.realizedPnL || 0);
            const unrealizedPnL = parseFloat(data.stats?.unrealizedPnL || 0);
            const pnlEl = document.getElementById('pnl');
            const pnlCard = document.getElementById('pnlCard');
            
            console.log('[Dashboard] PnL updating: totalPnL=', totalPnL, 'type=', typeof totalPnL);
            
            if (pnlEl) {
                if (isFinite(totalPnL)) {
                    pnlEl.textContent = `R$ ${safeFormat(totalPnL, 2)} ${totalPnL > 0 ? 'üìà' : totalPnL < 0 ? 'üìâ' : 'üòê'}`;
                } else {
                    pnlEl.textContent = 'R$ 0,00 üòê';
                }
                
                // Atualizar cor da borda do card PnL dinamicamente (sempre vis√≠vel)
                if (pnlCard) {
                    if (totalPnL > 0) {
                        pnlEl.className = "text-green-400 text-lg sm:text-xl font-bold";
                        pnlCard.classList.remove('border-red-500', 'border-gray-500');
                        pnlCard.classList.add('border-green-500');
                    } else if (totalPnL < 0) {
                        pnlEl.className = "text-red-400 text-lg sm:text-xl font-bold";
                        pnlCard.classList.remove('border-green-500', 'border-gray-500');
                        pnlCard.classList.add('border-red-500');
                    } else {
                        pnlEl.className = "text-gray-400 text-lg sm:text-xl font-bold";
                        pnlCard.classList.remove('border-green-500', 'border-red-500');
                        pnlCard.classList.add('border-gray-500');
                    }
                }
            }
            
            const roi = parseFloat(data.stats?.roi || 0);
            const roiEls = [document.getElementById('roiCard'), document.getElementById('roiList')];
            roiEls.forEach((roiEl) => {
                if (!roiEl) return;
                roiEl.textContent = `${isFinite(roi) ? safeFormat(roi, 2) : '0.00'}%`;
                if (roi > 0) {
                    roiEl.className = 'text-green-400';
                } else if (roi < 0) {
                    roiEl.className = 'text-red-400';
                } else {
                    roiEl.className = 'text-gray-400';
                }
            });

            const pnlStatusEl = document.getElementById('pnlStatus');
            if (pnlStatusEl) {
                if (totalPnL > 0) {
                    pnlStatusEl.textContent = 'Resultado: Ganhando';
                    pnlStatusEl.className = 'text-xs sm:text-sm text-green-400';
                } else if (totalPnL < 0) {
                    pnlStatusEl.textContent = 'Resultado: Perdendo';
                    pnlStatusEl.className = 'text-xs sm:text-sm text-red-400';
                } else {
                    pnlStatusEl.textContent = 'Resultado: Neutro';
                    pnlStatusEl.className = 'text-xs sm:text-sm text-gray-400';
                }
            }

            const roiBaseEl = document.getElementById('roiBase');
            if (roiBaseEl) {
                const base = parseFloat(data.stats?.baseCapital || data.stats?.initialCapital || 0);
                roiBaseEl.textContent = `Base ROI: R$ ${safeFormat(base, 2)}`;
            }

            const netContrib = parseFloat(data.stats?.netContributions || 0);
            const netContribEl = document.getElementById('netContrib');
            if (netContribEl) {
                netContribEl.textContent = `Aportes liquido: R$ ${safeFormat(netContrib, 2)}`;
                netContribEl.className = netContrib >= 0 ? 'text-xs text-gray-500' : 'text-xs text-red-400';
            }
            const netContribListEl = document.getElementById('netContribList');
            if (netContribListEl) {
                netContribListEl.textContent = `R$ ${safeFormat(netContrib, 2)}`;
                netContribListEl.className = netContrib >= 0 ? 'text-green-400' : 'text-red-400';
            }

            const unrealizedEl = document.getElementById('unrealizedPnl');
            if (unrealizedEl) {
                const icon = unrealizedPnL > 0 ? 'üìà' : unrealizedPnL < 0 ? 'üìâ' : 'üòê';
                unrealizedEl.textContent = `R$ ${safeFormat(unrealizedPnL, 2)} ${icon}`;
                unrealizedEl.className = unrealizedPnL > 0 ? 'text-green-400' : unrealizedPnL < 0 ? 'text-red-400' : 'text-gray-400';
            }

            const realizedEl = document.getElementById('realizedPnl');
            if (realizedEl) {
                const icon = realizedPnL > 0 ? 'üìà' : realizedPnL < 0 ? 'üìâ' : 'üòê';
                realizedEl.textContent = `R$ ${safeFormat(realizedPnL, 2)} ${icon}`;
                realizedEl.className = realizedPnL > 0 ? 'text-green-400' : realizedPnL < 0 ? 'text-red-400' : 'text-gray-400';
            }

            const brlEl = document.getElementById('brl');
            const btcEl = document.getElementById('btc');
            const totalBalanceCard = document.getElementById('totalBalanceCard');
            const totalBalanceList = document.getElementById('totalBalanceList');
            
            if (brlEl) brlEl.textContent = `R$ ${safeFormat(data.balance?.brl || 0, 2)}`;
            if (btcEl) btcEl.textContent = `${(parseFloat(data.balance?.btc || 0) || 0).toFixed(8)} BTC`;
            
            const total = parseFloat(data.balance?.total || 0) || 0;
            const totalFormatted = `R$ ${safeFormat(total, 2)}`;
            if (totalBalanceCard) totalBalanceCard.textContent = totalFormatted;
            if (totalBalanceList) totalBalanceList.textContent = totalFormatted;

            const tbody = document.getElementById('ordersTable');
            tbody.innerHTML = '';
            (data.activeOrders || []).forEach(order => {
                const age = order.ageSecMinHour || {ageHour: 0, ageMin: 0, ageSec: 0};
                const ageStr = `${String(age.ageHour).padStart(2, '0')}:${String(age.ageMin % 60).padStart(2, '0')}:${String(age.ageSec % 60).padStart(2, '0')}`;
                const minRepriceAgeSec = parseInt(data.config?.minRepriceAgeSec || 86400, 10);
                const remainingSec = Math.max(0, (minRepriceAgeSec || 0) - (age.ageSec || 0));
                const remainingStr = formatHms(remainingSec);
                const priceFormatted = window.safeBRFormat(order.price || 0, 2);
                const orderPrice = parseFloat(order.price || 0);
                const priceVsLast = (order.side === 'buy' && orderPrice > lastPrice)
                    ? '<span class="text-yellow-400" title="BUY acima do ultimo preco">‚ñ≤</span>'
                    : '';
                const tr = document.createElement('tr');
                const pairId = order.pair_id ? order.pair_id : '‚ùå Sem par';
                
                // Status do Exchange: mostrar ID ou "Aguardando coloca√ß√£o"
                let exchangeStatusDisplay = '‚ùì';
                if (order.exchangeStatus && order.exchangeStatus.includes('Aguardando')) {
                    exchangeStatusDisplay = `<span class="text-yellow-400 animate-pulse">${order.exchangeStatus}</span>`;
                } else if (order.exchangeId) {
                    exchangeStatusDisplay = `<span class="text-green-400 font-mono text-xs">${order.exchangeId.substring(0, 12)}...</span>`;
                } else if (order.exchangeStatus && order.exchangeStatus !== 'N/A') {
                    exchangeStatusDisplay = `<span class="text-green-400 font-mono text-xs">${order.exchangeStatus.substring(0, 12)}...</span>`;
                } else {
                    exchangeStatusDisplay = '‚úÖ Ativa';
                }
                
                tr.innerHTML = `
                    <td class="${order.side === 'buy' ? 'text-green-400' : 'text-red-400'} p-1 sm:p-2">${order.side || '--'}</td>
                    <td class="p-1 sm:p-2 font-mono text-xs truncate">${order.id || '--'}</td>
                    <td class="p-1 sm:p-2 text-yellow-300 font-mono text-xs truncate">${pairId}</td>
                    <td class="p-1 sm:p-2">R$ ${priceFormatted} ${priceVsLast}</td>
                    <td class="p-1 sm:p-2">${parseFloat(order.qty || '0').toFixed(8)}</td>
                    <td class="p-1 sm:p-2">${order.status || '--'}</td>
                    <td class="p-1 sm:p-2">${exchangeStatusDisplay}</td>
                    <td class="p-1 sm:p-2">${order.drift || '--'}</td>
                    <td class="p-1 sm:p-2">${ageStr} <span class="text-gray-500">| restante ${remainingStr}</span></td>
                `;
                tbody.appendChild(tr);
            });

            // ========== GR√ÅFICOS ==========
            try {
                if (typeof pnlChart !== 'undefined' && typeof btcChart !== 'undefined' && 
                    pnlChart && btcChart && 
                    data.stats?.pnlHistory?.length > 0 && data.stats?.pnlTimestamps?.length > 0) {
                    console.log('[Dashboard] Updating charts...');
                    
                    const nowMs = Date.now();
                    const cutoffMs = nowMs - (24 * 60 * 60 * 1000);
                    const validPnLData = data.stats.pnlHistory
                        .map((val, i) => ({value: parseFloat(val), timestamp: data.stats.pnlTimestamps[i]}))
                        .filter(item => {
                            if (isNaN(item.value) || item.value >= 1e10 || !item.timestamp) return false;
                            const ts = new Date(item.timestamp).getTime();
                            return !isNaN(ts) && ts >= cutoffMs;
                        });
                    
                    // Carregar hist√≥rico de pre√ßo BTC do servidor
                    const validPriceData = (data.stats?.priceHistory || [])
                        .map((price, i) => ({price: parseFloat(price), timestamp: data.stats.priceTimestamps[i]}))
                        .filter(item => !isNaN(item.price) && item.timestamp);
                    
                    // IMPORTANTE: Sempre recarregar dados completos do servidor
                    // Isso garante que ao fazer refresh, o hist√≥rico persista
                    const shouldRebuildPnLChart = pnlChart.data.labels.length === 0;
                    const shouldRebuildBtcChart = btcChart.data.labels.length === 0;
                    
                    if (shouldRebuildPnLChart) {
                        // Primeira carga ou depois do refresh: carregar todos os dados do PnL
                        pnlChart.data.labels = validPnLData.map(item => new Date(item.timestamp));
                        pnlChart.data.datasets[0].data = validPnLData.map(item => ({
                            x: new Date(item.timestamp),
                            y: item.value
                        }));
                        pnlChart.update();
                    } else {
                        // Atualiza√ß√£o normal do PnL: apenas adiciona novo ponto
                        const lastTimestamp = pnlChart.data.labels[pnlChart.data.labels.length - 1];
                        const newTimestamp = new Date(data.timestamp);
                        if (!lastTimestamp || (newTimestamp - lastTimestamp) >= 60000) {
                            const lastValidPnL = validPnLData.length > 0 ? validPnLData[validPnLData.length - 1].value : parseFloat(data.stats.totalPnL || '0.06');
                            
                            pnlChart.data.labels.push(newTimestamp);
                            pnlChart.data.datasets[0].data.push({
                                x: newTimestamp,
                                y: lastValidPnL
                            });
                        }
                    }
                    
                    // Manter apenas os √∫ltimos 60 pontos para performance (PnL)
                    if (pnlChart.data.labels.length > 60) {
                        pnlChart.data.labels.shift();
                        pnlChart.data.datasets[0].data.shift();
                    }
                    pnlChart.update();
                    
                    // ===== GR√ÅFICO DE BTC PRICE =====
                    if (shouldRebuildBtcChart) {
                        // Primeira carga: carregar hist√≥rico de pre√ßo
                        if (validPriceData.length > 0) {
                            btcChart.data.labels = validPriceData.map(item => new Date(item.timestamp));
                            btcChart.data.datasets[0].data = validPriceData.map(item => ({
                                x: new Date(item.timestamp),
                                y: item.price
                            }));
                        }
                        btcChart.update();
                    } else {
                        // Atualiza√ß√£o normal: adiciona novo ponto
                        const lastTimestamp = btcChart.data.labels[btcChart.data.labels.length - 1];
                        const newTimestamp = new Date(data.timestamp);
                        if (!lastTimestamp || (newTimestamp - lastTimestamp) >= 60000) {
                            const currentPrice = validPriceData.length > 0 ? validPriceData[validPriceData.length - 1].price : parseFloat(data.market?.last || 490000);
                            
                            btcChart.data.labels.push(newTimestamp);
                            btcChart.data.datasets[0].data.push({
                                x: newTimestamp,
                                y: currentPrice
                            });
                        }
                    }
                    
                    // Manter apenas os √∫ltimos 60 pontos para performance (BTC Price)
                    if (btcChart.data.labels.length > 60) {
                        btcChart.data.labels.shift();
                        btcChart.data.datasets[0].data.shift();
                    }
                    btcChart.update();
                    
                    console.log('[Dashboard] ‚úÖ Charts updated successfully');
                } else {
                    console.log('[Dashboard] Charts not available or no historical data');
                }
            } catch (chartError) {
                console.error('[Dashboard] ‚ùå Chart error:', chartError);
            }

            // Atualizar elementos de configura√ß√£o com verifica√ß√£o de null
            const setElementText = (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
                else console.warn(`[Dashboard] Element #${id} not found`);
            };

            setElementText('orderSize', data.config?.orderSize
                ? `${data.config.orderSize} BTC (~R$ ${(data.config.orderSize * (data.market?.last || 654973.00)).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })})`
                : '0.00005 BTC (~R$ 32,75)');
            setElementText('targetSpread', data.config?.spreadPct
                ? `${(data.config.spreadPct * 100).toFixed(2)}% ${data.config.spreadPct < 0.01 ? '‚úÖ' : data.config.spreadPct < 0.02 ? 'üòê' : '‚ö†Ô∏è'}`
                : '0.02% ‚úÖ');
            setElementText('cycleSec', `${data.config?.cycleSec || 15}s`);
            setElementText('stopLoss', data.config?.stopLoss
                ? `${(data.config.stopLoss * 100).toFixed(2)}%`
                : '0.80%');
            setElementText('takeProfit', data.config?.takeProfit
                ? `${(data.config.takeProfit * 100).toFixed(2)}%`
                : '2.00%');
            setElementText('minVolume', data.config?.minVolume
                ? `${data.config.minVolume} BTC`
                : '0.00005 BTC');
            setElementText('volatilityLimit', data.config?.volatilityLimit
                ? `${(data.config.volatilityLimit).toFixed(2)}%`
                : '3.50%');
            
            const rsiEl = document.getElementById('rsi');
            if (rsiEl) {
                rsiEl.textContent = data.market?.tendency?.rsi
                    ? `${parseFloat(data.market.tendency.rsi).toFixed(2)} ${data.market.tendency.rsi >= 30 && data.market.tendency.rsi <= 70 ? '‚úÖ' : '‚ö†Ô∏è'}`
                    : data.stats?.rsi ? `${parseFloat(data.stats.rsi).toFixed(2)} ‚úÖ` : '45.86 ‚úÖ';
                if (rsiEl.parentElement) {
                    rsiEl.parentElement.className = data.market?.tendency?.rsi && (data.market.tendency.rsi >= 30 && data.market.tendency.rsi <= 70) ? 'p-1 rounded pulse-green' : 'p-1 rounded';
                }
            }
            
            setElementText('emaShort', data.market?.tendency?.emaShort
                ? `R$ ${window.safeBRFormat(data.market.tendency.emaShort, 2)}`
                : data.stats?.emaShort ? `R$ ${window.safeBRFormat(data.stats.emaShort, 2)}` : 'R$ 481.857,04');
            setElementText('emaLong', data.market?.tendency?.emaLong
                ? `R$ ${window.safeBRFormat(data.market.tendency.emaLong, 2)}`
                : data.stats?.emaLong ? `R$ ${window.safeBRFormat(data.stats.emaLong, 2)}` : 'R$ 481.761,71');
            setElementText('macd', data.market?.tendency?.macd
                ? parseFloat(data.market.tendency.macd).toFixed(2)
                : '382.09');
            
            const signalEl = document.getElementById('signal');
            if (signalEl) {
                signalEl.textContent = data.market?.tendency?.signal
                    ? `${parseFloat(data.market.tendency.signal).toFixed(2)} ${Math.abs(data.market.tendency.signal) > 1000 ? '‚ö†Ô∏è' : '‚úÖ'}`
                    : '382.09 ‚úÖ';
                if (signalEl.parentElement) {
                    signalEl.parentElement.className = data.market?.tendency?.signal && Math.abs(data.market.tendency.signal) > 1000 ? 'p-1 rounded pulse-orange' : 'p-1 rounded pulse-green';
                }
            }
            
            setElementText('expectedProfitScore', data.stats?.expectedProfitScore
                ? `${parseFloat(data.stats.expectedProfitScore).toFixed(2)} ${data.stats.expectedProfitScore >= 0.1 ? '‚úÖ' : '‚ö†Ô∏è'}`
                : '1.00 ‚úÖ');
            
            const confidenceEl = document.getElementById('confidence');
            if (confidenceEl) {
                confidenceEl.textContent = data.market?.tendency?.confidence
                    ? `${parseFloat(data.market.tendency.confidence).toFixed(2)} ${data.market.tendency.confidence >= 0.5 ? '‚úÖ' : '‚ö†Ô∏è'}`
                    : '1.00 ‚úÖ';
            }
            
            setElementText('inventoryBias', data.stats?.inventoryBias
                ? parseFloat(data.stats.inventoryBias).toFixed(6)
                : '0.000013');
            setElementText('trendBias', data.stats?.trendBias
                ? parseFloat(data.stats.trendBias).toFixed(6)
                : '-0.026300');
            setElementText('totalBias', data.stats?.totalBias
                ? parseFloat(data.stats.totalBias).toFixed(6)
                : '-0.010000');

            // Atualizar dados de tend√™ncia externa
            if (data.externalTrend) {
                if (data.externalTrend.error) {
                    setElementText('alignment', '‚ùå Indispon√≠vel');
                    const alignmentStatusEl = document.getElementById('alignmentStatus');
                    if (alignmentStatusEl) alignmentStatusEl.className = 'p-1 rounded pulse-orange';
                    setElementText('externalTrend', '--');
                    setElementText('externalConfidence', '--');
                    setElementText('externalScore', '--');
                    setElementText('externalSources', 'Offline');
                    setElementText('botVsExternal', `Bot: ${data.externalTrend.botTrend || '--'} (${parseFloat(data.externalTrend.botConfidence || 0).toFixed(2)})`);
                } else {
                    // Status de alinhamento
                    const isAligned = data.externalTrend.botAlignment === 'aligned';
                    setElementText('alignment', isAligned ? '‚úÖ Alinhado' : '‚ö†Ô∏è Divergente');
                    const alignmentStatusEl = document.getElementById('alignmentStatus');
                    if (alignmentStatusEl) alignmentStatusEl.className = isAligned ? 'p-1 rounded pulse-green' : 'p-1 rounded pulse-orange';
                    
                    // Tend√™ncia externa
                    const trendIcon = data.externalTrend.trend === 'up' ? 'üî•' : data.externalTrend.trend === 'down' ? '‚ùÑÔ∏è' : '‚û°Ô∏è';
                    setElementText('externalTrend', `${data.externalTrend.trend} ${trendIcon}`);
                    
                    // Confian√ßa externa
                    setElementText('externalConfidence', `${parseFloat(data.externalTrend.confidence).toFixed(2)} ${data.externalTrend.confidence >= 0.5 ? '‚úÖ' : '‚ö†Ô∏è'}`);
                    
                    // Score
                    const score = parseFloat(data.externalTrend.score);
                    const scoreIcon = score > 0.1 ? 'üìà' : score < -0.1 ? 'üìâ' : '‚û°Ô∏è';
                    setElementText('externalScore', `${score.toFixed(2)} ${scoreIcon}`);
                    
                    // Status das fontes
                    const sources = data.externalTrend.sources;
                    const sourcesStatus = [];
                    if (sources.coinGecko) sourcesStatus.push('CG‚úÖ');
                    if (sources.binance) sourcesStatus.push('BIN‚úÖ');
                    if (sources.fearGreed) sourcesStatus.push('FG‚úÖ');
                    setElementText('externalSources', sourcesStatus.length > 0 ? sourcesStatus.join(' ') : 'Nenhuma ativa');
                    
                    // Compara√ß√£o Bot vs Externo
                    if (data.externalTrend.details) {
                        const botTrendIcon = data.externalTrend.details.botTrend === 'up' ? 'üî•' : data.externalTrend.details.botTrend === 'down' ? '‚ùÑÔ∏è' : '‚û°Ô∏è';
                        const extTrendIcon = data.externalTrend.details.externalTrend === 'up' ? 'üî•' : data.externalTrend.details.externalTrend === 'down' ? '‚ùÑÔ∏è' : '‚û°Ô∏è';
                        setElementText('botVsExternal', `${botTrendIcon} ${parseFloat(data.externalTrend.details.botConfidence).toFixed(2)} vs ${extTrendIcon} ${parseFloat(data.externalTrend.details.externalConfidence).toFixed(2)}`);
                    }
                }
            } else {
                setElementText('alignment', '‚ùì Sem dados');
                const alignmentStatusEl = document.getElementById('alignmentStatus');
                if (alignmentStatusEl) alignmentStatusEl.className = 'p-1 rounded';
                setElementText('externalTrend', '--');
                setElementText('externalConfidence', '--');
                setElementText('externalScore', '--');
                setElementText('externalSources', '--');
                setElementText('botVsExternal', '--');
            }

            const unrealizedPnlEl = document.getElementById('unrealizedPnl');
            if (unrealizedPnlEl) {
                unrealizedPnlEl.textContent = data.stats?.unrealizedPnl
                    ? `R$ ${parseFloat(data.stats.unrealizedPnl).toFixed(2)} ${data.stats.unrealizedPnl > 0 ? 'üìà' : data.stats.unrealizedPnl < 0 ? 'üìâ' : 'üòê'}`
                    : 'R$ 0.00 üìà';
                if (unrealizedPnlEl.parentElement) {
                    unrealizedPnlEl.parentElement.className = data.stats?.unrealizedPnl && data.stats.unrealizedPnl < 0 ? 'p-1 rounded pulse-orange' : 'p-1 rounded pulse-green';
                }
            }
            setElementText('btcPosition', data.stats?.btcPosition
                ? `${parseFloat(data.stats.btcPosition).toFixed(8)} BTC`
                : '0.00002000 BTC');
            setElementText('fillRate', data.stats?.fillRate
                ? `${data.stats.fillRate} ${data.stats.fillRate.replace('%', '') >= 20 ? '‚úÖ' : '‚ö†Ô∏è'}`
                : '24.0% ‚úÖ');
            setElementText('avgFillPrice', data.stats?.avgFillPrice
                ? `R$ ${window.safeBRFormat(data.stats.avgFillPrice, 2)}`
                : 'R$ 654.259,13');
            setElementText('uptime', data.stats?.uptime
                ? `${data.stats.uptime}`
                : '23 minutos');
            
            const roiEl2 = document.getElementById('roi');
            if (roiEl2) {
                roiEl2.textContent = data.stats?.roi
                    ? `${parseFloat(data.stats.roi).toFixed(2)}% ${data.stats.roi > 0 ? 'üìà' : data.stats.roi < 0 ? 'üìâ' : 'üòê'}`
                    : '0.01% üìà';
                if (roiEl2.parentElement) {
                    roiEl2.parentElement.className = data.stats?.roi && data.stats.roi < 0 ? 'p-1 rounded pulse-orange' : 'p-1 rounded pulse-green';
                }
            }
            
            const regimeEl = document.getElementById('regime');
            if (regimeEl && data.stats?.regime) {
                regimeEl.textContent = data.stats.regime;
                regimeEl.className = data.stats.regime.includes('BULL') ? 'text-green-400 font-bold' : 
                                   data.stats.regime.includes('BEAR') ? 'text-red-400 font-bold' : 'text-gray-400 font-bold';
            }

            const trendEl = document.getElementById('trend');
            if (trendEl) {
                const priceToUse = data.config?.simulate ? parseFloat(data.market?.tendency?.midPrice || 654973.00) : parseFloat(data.market?.last || 654973.00);
                if (data.market?.tendency?.trend === 'up') {
                    trendEl.textContent = `Alta üìà - R$ ${priceToUse.toLocaleString('pt-BR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    })}`;
                    trendEl.className = "text-green-400 font-bold";
                    if (trendEl.parentElement) trendEl.parentElement.className = 'p-1 rounded pulse-green';
                } else if (data.market?.tendency?.trend === 'down') {
                    trendEl.textContent = `Baixa üìâ - R$ ${priceToUse.toLocaleString('pt-BR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    })}`;
                    trendEl.className = "text-red-400 font-bold";
                    if (trendEl.parentElement) trendEl.parentElement.className = 'p-1 rounded pulse-orange';
                } else {
                    trendEl.textContent = `Neutra ‚û°Ô∏è - R$ ${priceToUse.toLocaleString('pt-BR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    })}`;
                    trendEl.className = "text-gray-400 font-bold";
                    if (trendEl.parentElement) trendEl.parentElement.className = 'p-1 rounded';
                }
            }

            // ===== CARREGAR PARES BUY/SELL =====
            try {
                const pairsRes = await fetch(`/api/pairs?t=${Date.now()}`);
                const pairsData = await pairsRes.json();
                latestPairsData = pairsData;
                
                if (pairsData && pairsData.pairs && Array.isArray(pairsData.pairs)) {
                    const displayPairs = showCompletedPairs
                        ? pairsData.pairs
                        : pairsData.pairs.filter(p => !(p.cycleComplete || p.executionIndicator === '‚úÖ CICLO COMPLETO'));

                    // Atualizar contadores completos do backend
                    setElementText('totalPairsCount', pairsData.totalPairs || pairsData.pairs.length || 0);
                    setElementText('completePairsCount', pairsData.completePairs || 0);
                    setElementText('incompletePairsCount', pairsData.incompletePairs || 0);
                    
                    // Calcular ROI m√©dio apenas para pares completos (n√£o exibidos)
                    const completePairs = pairsData.pairs.filter(p => p.status === 'COMPLETO');
                    let avgRoi = 0;
                    if (completePairs.length > 0) {
                        const totalRoi = completePairs.reduce((sum, p) => {
                            const roiStr = p.roi || '0.000%';
                            const roiVal = parseFloat(roiStr.replace('%', ''));
                            return sum + roiVal;
                        }, 0);
                        avgRoi = totalRoi / completePairs.length;
                    }
                    setElementText('avgPairRoi', avgRoi.toFixed(3) + '%');
                    
                    // Atualizar tabela de pares
                    const tbody = document.getElementById('pairsTableBody');
                    tbody.innerHTML = '';
                    
                    if (displayPairs.length === 0) {
                        const emptyLabel = showCompletedPairs
                            ? 'Nenhum par registrado'
                            : 'Nenhum par pendente';
                        tbody.innerHTML = `<tr><td class="p-2 text-gray-400 text-center" colspan="10">${emptyLabel}</td></tr>`;
                    } else {
                        displayPairs.forEach(pair => {
                            const tr = document.createElement('tr');
                            tr.className = 'border-b border-gray-700 hover:bg-gray-700 transition';
                            
                            // Determinar cores baseado em status
                            let statusColor = 'text-yellow-400';
                            let statusIcon = '‚è≥';
                            if (pair.status === 'COMPLETO') {
                                statusColor = 'text-green-400';
                                statusIcon = '‚úÖ';
                            } else if (pair.status === 'AGUARDANDO_BUY') {
                                statusColor = 'text-orange-400';
                                statusIcon = 'üî¥';
                            } else if (pair.status === 'AGUARDANDO_SELL') {
                                statusColor = 'text-blue-400';
                                statusIcon = 'üü¢';
                            }
                            
                            const spreadVal = pair.spread || '0.000%';
                            const roiVal = pair.roi || '0.000%';
                            const spreadNum = parseFloat(spreadVal.replace('%', ''));
                            const roiNum = parseFloat(roiVal.replace('%', ''));
                            
                            tr.innerHTML = `
                                <td class="p-2 text-gray-300 font-mono text-xs truncate" title="${pair.pairId}">
                                    ${pair.pairId}
                                </td>
                                <td class="p-2">
                                    <span class="${statusColor} font-semibold">${statusIcon} ${pair.status}</span>
                                </td>
                                <td class="p-2 text-center text-sm">
                                    ${pair.buyOrder ? `<div>üü¢ R$ ${window.safeBRFormat(parseFloat(pair.buyOrder.price || 0), 2)}</div><div class="text-xs text-gray-400">${pair.buyExecutionIndicator || '‚ö™'}</div>` : '‚ùå'}
                                </td>
                                <td class="p-2 text-center text-sm">
                                    ${pair.sellOrder ? `<div>üî¥ R$ ${window.safeBRFormat(parseFloat(pair.sellOrder.price || 0), 2)}</div><div class="text-xs text-gray-400">${pair.sellExecutionIndicator || '‚ö™'}</div>` : '‚ùå'}
                                </td>
                                <td class="p-2 text-right ${spreadNum >= 0 ? 'text-green-400' : 'text-red-400'} font-semibold">
                                    ${spreadVal}
                                </td>
                                <td class="p-2 text-right ${roiNum >= 0 ? 'text-green-400' : 'text-red-400'} font-semibold">
                                    ${roiVal}
                                </td>
                                <td class="p-2 text-center text-xs">
                                    ${pair.executionIndicator || '‚è≥ AGUARDANDO'}
                                </td>
                                <td class="p-2 text-center">
                                    <button onclick="cancelPair('${pair.pairId}')" 
                                        class="px-2 py-1 bg-red-600 hover:bg-red-500 rounded text-white text-xs transition" 
                                        title="Cancelar todas as ordens deste par">
                                        ‚ùå Cancelar
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                    
                    // Atualizar badge de refresh
                    const pairsRefreshBadge = document.getElementById('pairsRefreshBadge');
                    if (pairsRefreshBadge) {
                        pairsRefreshBadge.textContent = `Atualizado ${new Date().toLocaleTimeString('pt-BR')}`;
                        pairsRefreshBadge.className = 'text-xs px-2 py-1 bg-green-700 rounded text-green-200';
                    }
                }
            } catch (pairsError) {
                console.error('‚ùå Erro ao carregar pares:', pairsError);
                const pairsRefreshBadge = document.getElementById('pairsRefreshBadge');
                if (pairsRefreshBadge) {
                    pairsRefreshBadge.textContent = 'Erro ao carregar pares';
                    pairsRefreshBadge.className = 'text-xs px-2 py-1 bg-red-700 rounded text-red-200';
                }
            }

            // ========== CARREGAR ORDENS DE MOMENTUM DO BANCO ==========
            // Momentum validation removido (2025-01-21)
        } catch (error) {
            console.error('[Dashboard] ‚ùå Error in loadData():', error);
            console.error('Full error:', error.toString(), error.stack);
        }
    }

    // ========== FUN√á√ïES DE TESTES AUTOMATIZADOS ==========
    
    let testsLoading = false;
    
    async function loadTestResults() {
        try {
            const res = await fetch(`/api/tests?t=${Date.now()}`);
            const data = await res.json();
            
            console.log('[Dashboard] Test results loaded:', data);
            
            const statusEl = document.getElementById('testsStatus');
            const runBtn = document.getElementById('runTestsBtn');
            
            if (data.isRunning) {
                if (statusEl) {
                    statusEl.textContent = '‚è≥ Executando testes...';
                    statusEl.className = 'text-xs px-2 py-1 bg-yellow-700 rounded text-yellow-200 animate-pulse';
                }
                if (runBtn) runBtn.disabled = true;
                return;
            }
            
            if (runBtn) runBtn.disabled = false;
            
            if (!data.hasResults || !data.results) {
                if (statusEl) {
                    statusEl.textContent = '‚è≥ Aguardando execu√ß√£o';
                    statusEl.className = 'text-xs px-2 py-1 bg-gray-700 rounded text-gray-300';
                }
                return;
            }
            
            const results = data.results;
            
            // Atualizar status
            if (statusEl) {
                if (results.status === 'completed') {
                    const passRate = parseFloat(results.summary.passRate || 0);
                    if (passRate >= 80) {
                        statusEl.textContent = '‚úÖ Testes OK';
                        statusEl.className = 'text-xs px-2 py-1 bg-green-700 rounded text-green-200';
                    } else if (passRate >= 50) {
                        statusEl.textContent = '‚ö†Ô∏è Aten√ß√£o';
                        statusEl.className = 'text-xs px-2 py-1 bg-yellow-700 rounded text-yellow-200';
                    } else {
                        statusEl.textContent = '‚ùå Problemas';
                        statusEl.className = 'text-xs px-2 py-1 bg-red-700 rounded text-red-200';
                    }
                } else if (results.status === 'error') {
                    statusEl.textContent = '‚ùå Erro';
                    statusEl.className = 'text-xs px-2 py-1 bg-red-700 rounded text-red-200';
                }
            }
            
            // Atualizar resumo
            document.getElementById('testsTotal').textContent = results.summary.total || '-';
            document.getElementById('testsPassed').textContent = results.summary.passed || '-';
            document.getElementById('testsFailed').textContent = results.summary.failed || '-';
            document.getElementById('testsPassRate').textContent = (results.summary.passRate || '0') + '%';
            document.getElementById('testsDataSource').textContent = results.summary.dataSource || '-';
            
            // Info do per√≠odo
            document.getElementById('testsHours').textContent = (results.hours || 24) + 'h';
            document.getElementById('testsDataPoints').textContent = results.summary.dataPoints || '-';
            
            if (results.summary.priceRange) {
                document.getElementById('testsPriceStart').textContent = 'R$ ' + parseFloat(results.summary.priceRange.start).toLocaleString('pt-BR');
                document.getElementById('testsPriceEnd').textContent = 'R$ ' + parseFloat(results.summary.priceRange.end).toLocaleString('pt-BR');
                
                const change = parseFloat(results.summary.priceRange.change);
                const changeEl = document.getElementById('testsPriceChange');
                changeEl.textContent = (change >= 0 ? '+' : '') + change + '%';
                changeEl.className = change >= 0 ? 'text-green-400 font-bold' : 'text-red-400 font-bold';
            }
            
            // √öltima execu√ß√£o
            if (data.lastRunTime) {
                const lastRun = new Date(data.lastRunTime);
                document.getElementById('testsLastRun').textContent = lastRun.toLocaleString('pt-BR');
            }
            
            if (data.cacheAgeSeconds) {
                const mins = Math.floor(data.cacheAgeSeconds / 60);
                document.getElementById('testsCacheAge').textContent = mins > 0 ? `${mins}m atr√°s` : 'agora';
            }
            
            // üí∞ PROJE√á√ÉO DE GANHOS - Pegar o melhor teste (maior vs HOLD)
            let bestTest = null;
            let bestVsHold = -Infinity;
            results.tests.forEach(t => {
                if (t.projection && t.vsHoldBRL !== undefined) {
                    const vsHold = parseFloat(t.vsHoldBRL);
                    if (vsHold > bestVsHold) {
                        bestVsHold = vsHold;
                        bestTest = t;
                    }
                }
            });
            
            const integratedTest = bestTest;
            if (integratedTest && integratedTest.projection) {
                // Atualizar nome do melhor teste
                document.getElementById('bestTestName').textContent = integratedTest.testName;
                
                const proj = integratedTest.projection;
                const pnl = parseFloat(integratedTest.pnlBRL || 0);
                const vsHold = parseFloat(integratedTest.vsHoldBRL || 0);
                const monthly = parseFloat(proj.monthlyBRL || 0);
                const yearly = parseFloat(proj.yearlyBRL || 0);
                
                // PnL no teste
                const pnlEl = document.getElementById('projPnlTest');
                pnlEl.textContent = 'R$ ' + pnl.toFixed(2);
                pnlEl.className = 'text-xl font-bold ' + (pnl >= 0 ? 'text-green-400' : 'text-red-400');
                
                // vs HOLD
                const vsHoldEl = document.getElementById('projVsHold');
                vsHoldEl.textContent = (vsHold >= 0 ? '+' : '') + 'R$ ' + vsHold.toFixed(2);
                vsHoldEl.className = 'text-xl font-bold ' + (vsHold >= 0 ? 'text-green-400' : 'text-red-400');
                
                // Proje√ß√£o Mensal
                const monthlyEl = document.getElementById('projMonthly');
                monthlyEl.textContent = (monthly >= 0 ? '+' : '') + 'R$ ' + monthly.toFixed(2);
                monthlyEl.className = 'text-xl font-bold ' + (monthly >= 0 ? 'text-green-400' : 'text-red-400');
                document.getElementById('projMonthlyRoi').textContent = proj.monthlyRoi + '% ROI';
                
                // Proje√ß√£o Anual
                const yearlyEl = document.getElementById('projYearly');
                yearlyEl.textContent = (yearly >= 0 ? '+' : '') + 'R$ ' + yearly.toFixed(2);
                yearlyEl.className = 'text-xl font-bold ' + (yearly >= 0 ? 'text-green-400' : 'text-red-400');
                document.getElementById('projYearlyRoi').textContent = proj.yearlyRoi + '% ROI';
                
                // Horas do teste
                document.getElementById('projHours').textContent = proj.hoursInTest;
            }
            
            // Tabela de resultados
            const tbody = document.getElementById('testsTableBody');
            if (tbody && results.tests && results.tests.length > 0) {
                tbody.innerHTML = '';
                
                results.tests.forEach(test => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-gray-700 hover:bg-gray-700 transition';
                    
                    const statusIcon = test.passed ? '‚úÖ' : '‚ùå';
                    const statusColor = test.passed ? 'text-green-400' : 'text-red-400';
                    
                    const pnl = parseFloat(test.pnlBRL || 0);
                    const pnlColor = pnl >= 0 ? 'text-green-400' : 'text-red-400';
                    
                    const vsHold = parseFloat(test.vsHoldBRL || 0);
                    const vsHoldColor = vsHold >= 0 ? 'text-green-400' : 'text-red-400';
                    
                    const roi = parseFloat(test.roi || 0);
                    const roiColor = roi >= 0 ? 'text-green-400' : 'text-red-400';
                    
                    const btcGained = parseFloat(test.btcGained || 0);
                    const btcColor = btcGained >= 0 ? 'text-green-400' : 'text-red-400';
                    
                    const monthly = test.projection ? parseFloat(test.projection.monthlyBRL || 0) : 0;
                    const monthlyColor = monthly >= 0 ? 'text-green-400' : 'text-red-400';
                    
                    // Para testes de Momentum (sem proje√ß√£o)
                    if (test.testName.includes('Momentum')) {
                        tr.innerHTML = `
                            <td class="p-2 text-gray-300">${test.testName}</td>
                            <td class="p-2 text-center ${statusColor}">${statusIcon}</td>
                            <td class="p-2 text-right text-gray-400">-</td>
                            <td class="p-2 text-right text-gray-400">-</td>
                            <td class="p-2 text-right text-purple-400">${test.accuracy || '-'}%</td>
                            <td class="p-2 text-right text-gray-400">-</td>
                            <td class="p-2 text-right text-gray-400">-</td>
                        `;
                    } 
                    // Para testes com proje√ß√£o (Accumulator e Integrado)
                    else {
                        tr.innerHTML = `
                            <td class="p-2 text-gray-300">${test.testName}</td>
                            <td class="p-2 text-center ${statusColor}">${statusIcon}</td>
                            <td class="p-2 text-right ${pnlColor}">R$ ${test.pnlBRL || '-'}</td>
                            <td class="p-2 text-right ${vsHoldColor}">${vsHold >= 0 ? '+' : ''}R$ ${test.vsHoldBRL || '-'}</td>
                            <td class="p-2 text-right ${roiColor}">${test.roi || '-'}%</td>
                            <td class="p-2 text-right ${btcColor}">${test.btcGained || '-'}</td>
                            <td class="p-2 text-right ${monthlyColor}">${test.projection ? (monthly >= 0 ? '+' : '') + 'R$ ' + test.projection.monthlyBRL : '-'}</td>
                        `;
                    }
                    
                    tbody.appendChild(tr);
                });
            }
            
        } catch (error) {
            console.error('‚ùå Erro ao carregar resultados de testes:', error);
            const statusEl = document.getElementById('testsStatus');
            if (statusEl) {
                statusEl.textContent = '‚ùå Erro ao carregar';
                statusEl.className = 'text-xs px-2 py-1 bg-red-700 rounded text-red-200';
            }
        }
    }
    
    async function runAutomatedTests() {
        const btn = document.getElementById('runTestsBtn');
        const statusEl = document.getElementById('testsStatus');
        
        if (testsLoading) return;
        testsLoading = true;
        
        try {
            if (btn) {
                btn.disabled = true;
                btn.textContent = '‚è≥ Executando...';
            }
            if (statusEl) {
                statusEl.textContent = '‚è≥ Iniciando testes...';
                statusEl.className = 'text-xs px-2 py-1 bg-yellow-700 rounded text-yellow-200 animate-pulse';
            }
            
            const res = await fetch('/api/tests/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ hours: 24 })
            });
            
            const data = await res.json();
            
            if (res.ok) {
                console.log('[Dashboard] Tests started:', data);
                // Aguardar um pouco e depois come√ßar a verificar
                setTimeout(loadTestResults, 3000);
                // Verificar a cada 2 segundos at√© completar
                const checkInterval = setInterval(async () => {
                    const statusRes = await fetch('/api/tests/status');
                    const statusData = await statusRes.json();
                    if (!statusData.isRunning) {
                        clearInterval(checkInterval);
                        await loadTestResults();
                        if (btn) {
                            btn.disabled = false;
                            btn.textContent = 'üîÑ Refazer Testes (24h)';
                        }
                        testsLoading = false;
                    }
                }, 2000);
            } else {
                throw new Error(data.error || 'Erro ao iniciar testes');
            }
            
        } catch (error) {
            console.error('‚ùå Erro ao executar testes:', error);
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'üîÑ Refazer Testes (24h)';
            }
            if (statusEl) {
                statusEl.textContent = '‚ùå Erro';
                statusEl.className = 'text-xs px-2 py-1 bg-red-700 rounded text-red-200';
            }
            testsLoading = false;
        }
    }

    function toggleCompletePairs() {
        showCompletedPairs = !showCompletedPairs;
        const btn = document.getElementById('toggleCompletePairsBtn');
        if (btn) {
            btn.textContent = showCompletedPairs ? '‚úÖ Completos (mostrar)' : '‚úÖ Completos (ocultar)';
            btn.className = showCompletedPairs
                ? 'text-xs px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded text-white transition'
                : 'text-xs px-3 py-1 bg-blue-700 hover:bg-blue-600 rounded text-white transition';
        }
        loadData();
    }

    function downloadPairsJson() {
        const pairs = latestPairsData?.pairs || [];
        const payload = {
            exportedAt: new Date().toISOString(),
            totalPairs: latestPairsData?.totalPairs || pairs.length,
            completePairs: latestPairsData?.completePairs || 0,
            incompletePairs: latestPairsData?.incompletePairs || 0,
            pairs
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pares_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    async function submitContribution(type) {
        const amountInput = document.getElementById('contribAmount');
        const noteInput = document.getElementById('contribNote');
        const amount = parseFloat(amountInput?.value || '0');
        const note = noteInput?.value || '';
        if (!amount || amount <= 0) {
            alert('Informe um valor valido.');
            return;
        }

        const btn = type === 'withdraw'
            ? document.getElementById('contribWithdrawBtn')
            : document.getElementById('contribAddBtn');

        if (btn) btn.disabled = true;
        try {
            const res = await fetch('/api/contributions', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({amount, type, note})
            });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || 'erro');
            }
            amountInput.value = '';
            noteInput.value = '';
            await loadData(true);
        } catch (e) {
            alert('Falha ao registrar aporte.');
        } finally {
            if (btn) btn.disabled = false;
        }
    }

    async function cancelPair(pairId) {
        // Confirma√ß√£o antes de cancelar
        if (!confirm(`‚ö†Ô∏è Tem certeza que deseja cancelar TODAS as ordens do par ${pairId.substring(0, 30)}...?`)) {
            return;
        }

        try {
            console.log(`[Dashboard] Cancelando par: ${pairId}`);
            
            const res = await fetch(`/api/pairs/cancel/${encodeURIComponent(pairId)}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await res.json();

            if (res.ok) {
                console.log(`[Dashboard] Resultado cancelamento:`, data);
                alert(`‚úÖ ${data.message}\n\nCanceladas: ${data.cancelledCount}\nFalhadas: ${data.failedCount}`);
                // Recarregar pares ap√≥s cancelamento
                setTimeout(loadData, 1000);
            } else {
                throw new Error(data.error || 'Erro ao cancelar par');
            }

        } catch (error) {
            console.error('‚ùå Erro ao cancelar par:', error);
            alert(`‚ùå Erro ao cancelar par:\n\n${error.message}`);
        }
    }

    async function clearAllOrders() {
        // Confirma√ß√£o de seguran√ßa - dupla verifica√ß√£o
        if (!confirm('‚ö†Ô∏è AVISO: Voc√™ est√° para LIMPAR TODOS OS PARES do sistema!\n\nTem certeza?')) {
            return;
        }
        if (!confirm('üö® √öLTIMA CHANCE: Deseja realmente LIMPAR TODOS OS PARES?\n\nIsso n√£o pode ser desfeito!')) {
            return;
        }

        const btn = document.getElementById('clearAllOrdersBtn');
        if (btn) btn.disabled = true;

        try {
            console.log('[Dashboard] üö® Limpando TODOS os pares...');
            
            const res = await fetch('/api/pairs/clear-all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await res.json();

            if (res.ok) {
                console.log(`[Dashboard] Resultado limpeza:`, data);
                alert(`üö® SISTEMA LIMPO!\n\n‚úÖ Pares removidos: ${data.clearedCount}\n‚ùå Com erro: ${data.failedCount}\nüìä Total processado: ${data.totalPairs}`);
                // Recarregar dados ap√≥s limpeza
                setTimeout(loadData, 1500);
            } else {
                throw new Error(data.error || 'Erro ao limpar pares');
            }

        } catch (error) {
            console.error('‚ùå Erro ao limpar pares:', error);
            alert(`‚ùå Erro ao limpar pares:\n\n${error.message}`);
        } finally {
            if (btn) btn.disabled = false;
        }
    }

    // Fun√ß√£o para iniciar ap√≥s gr√°ficos estarem prontos
    function startDataLoading() {
        console.log('[Dashboard] ‚úÖ Starting data loading cycle...');
        loadData();
        // loadTestResults(); // DESABILITADO: Teste autom√°tico apenas em dev local, n√£o em Render (Binance 451)
        setInterval(loadData, 5 * 1000);
        // setInterval(loadTestResults, 30 * 1000); // DESABILITADO: Teste autom√°tico com polling
    }

    // Aguardar gr√°ficos serem criados (eles s√£o criados no primeiro DOMContentLoaded)
    // Usar setTimeout para garantir que o primeiro listener j√° executou
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            // Aguardar 100ms para garantir que os gr√°ficos foram criados
            setTimeout(startDataLoading, 100);
        });
    } else {
        // DOM j√° carregado, aguardar gr√°ficos
        setTimeout(startDataLoading, 100);
    }
</script>
</body>
</html>