<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MB Bot Dashboard</title>

    <!-- Tailwind CSS (modo CDN, n√£o recomendado para produ√ß√£o) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js e plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <!-- date-fns -->
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>

    <style>
        @keyframes pulse-green {
            0% {
                background-color: rgba(74, 222, 128, 0.1);
            }
            50% {
                background-color: rgba(74, 222, 128, 0.3);
            }
            100% {
                background-color: rgba(74, 222, 128, 0.1);
            }
        }

        @keyframes pulse-orange {
            0% {
                background-color: rgba(251, 146, 60, 0.1);
            }
            50% {
                background-color: rgba(251, 146, 60, 0.3);
            }
            100% {
                background-color: rgba(251, 146, 60, 0.1);
            }
        }

        .pulse-green {
            animation: pulse-green 2s infinite;
        }

        .pulse-orange {
            animation: pulse-orange 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">
<div class="container mx-auto p-4">

    <!-- Header -->
    <div class="flex justify-between items-center mb-4">
        <h1 class="text-xl sm:text-2xl font-bold">üìä MB Bot Dashboard</h1>
        <span id="mode" class="px-2 py-1 sm:px-3 sm:py-1 bg-green-600 rounded-full text-xs sm:text-sm">Modo: Live</span>
    </div>

    <!-- Cards -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <p class="text-gray-400 text-xs sm:text-sm">√öltimo Pre√ßo</p>
            <h2 id="lastPrice" class="text-lg sm:text-xl font-bold">R$ 654.973,00</h2>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <p class="text-gray-400 text-xs sm:text-sm">Spread</p>
            <h2 id="spread" class="text-lg sm:text-xl font-bold">0.06% (muito baixo) ‚úÖ</h2>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <p class="text-gray-400 text-xs sm:text-sm">Volatilidade</p>
            <h2 id="volatility" class="text-lg sm:text-xl font-bold">0.26% (est√°vel) ‚úÖ</h2>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <p class="text-gray-400 text-xs sm:text-sm">PnL (Total / M√™s)</p>
            <h2 id="pnl" class="text-lg sm:text-xl font-bold text-green-400">R$ 0.06 üìà</h2>
            <p id="monthlyPnl" class="text-xs sm:text-sm text-gray-300">Mensal: R$ 0.06</p>
        </div>
    </div>

    <!-- Conte√∫do principal -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Tabela de Ordens -->
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-2">Ordens Ativas</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-xs sm:text-sm">
                    <thead>
                    <tr class="text-gray-400">
                        <th class="text-left p-1 sm:p-2">Side</th>
                        <th class="text-left p-1 sm:p-2">ID</th>
                        <th class="text-left p-1 sm:p-2">Pre√ßo</th>
                        <th class="text-left p-1 sm:p-2">Qtd</th>
                        <th class="text-left p-1 sm:p-2">Status</th>
                        <th class="text-left p-1 sm:p-2">Drift</th>
                        <th class="text-left p-1 sm:p-2">Age</th>
                    </tr>
                    </thead>
                    <tbody id="ordersTable">
                    <tr>
                        <td class="text-red-400 p-1 sm:p-2">sell</td>
                        <td class="p-1 sm:p-2">01K70C1BRYAXM0PD92BRESXN7A</td>
                        <td class="p-1 sm:p-2">R$ 655.532,00</td>
                        <td class="p-1 sm:p-2">0.000020</td>
                        <td class="p-1 sm:p-2">working</td>
                        <td class="p-1 sm:p-2">281.50</td>
                        <td class="p-1 sm:p-2">00:04:19</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Saldos -->
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-2">Saldos</h2>
            <ul class="space-y-1 text-xs sm:text-sm">
                <li>BRL: <span id="brl">R$ 393,35</span></li>
                <li>BTC: <span id="btc">0.00032331 BTC</span></li>
                <li>Total: <span id="total">R$ 605,11</span></li>
                <li>Uptime: <span id="uptime">23 minutos</span></li>
            </ul>
        </div>
    </div>

    <!-- Gr√°ficos + Config -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-2">Evolu√ß√£o do PnL</h2>
            <div class="w-full h-64 sm:h-72">
                <canvas id="pnlChart"></canvas>
            </div>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-4">Config & Tend√™ncia</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- Configura√ß√µes do Bot -->
                <div>
                    <h3 class="text-sm font-semibold mb-2 text-gray-300">Configura√ß√µes do Bot</h3>
                    <ul class="space-y-1 text-xs sm:text-sm">
                        <li title="Tamanho m√≠nimo de cada ordem em BTC" class="p-1 rounded pulse-green">
                            Ordem m√≠nima: <span id="orderSize">0.000095 BTC (~R$ 62,25)</span>
                        </li>
                        <li title="Percentual alvo de diferen√ßa entre compra e venda" class="p-1 rounded pulse-green">
                            Spread alvo: <span id="targetSpread">0.07% ‚úÖ</span>
                        </li>
                        <li title="Intervalo entre ciclos de decis√£o do bot" class="p-1 rounded">
                            Intervalo ciclo: <span id="cycleSec">15s</span>
                        </li>
                        <li title="Limite de perda para cancelar ordens" class="p-1 rounded">
                            Stop-Loss: <span id="stopLoss">0.80%</span>
                        </li>
                        <li title="Meta de lucro para realizar ganhos" class="p-1 rounded">
                            Take-Profit: <span id="takeProfit">2.00%</span>
                        </li>
                        <li title="Volume m√≠nimo para ordens serem v√°lidas" class="p-1 rounded">
                            Volume M√≠nimo: <span id="minVolume">0.00005 BTC</span>
                        </li>
                        <li title="Limite m√°ximo de volatilidade para operar" class="p-1 rounded">
                            Limite de Volatilidade: <span id="volatilityLimit">5.00%</span>
                        </li>
                    </ul>
                </div>
                <!-- Indicadores T√©cnicos -->
                <div>
                    <h3 class="text-sm font-semibold mb-2 text-gray-300">Indicadores T√©cnicos</h3>
                    <ul class="space-y-1 text-xs sm:text-sm">
                        <li title="Tend√™ncia do mercado com base em indicadores" class="p-1 rounded">
                            Tend√™ncia: <span id="trend" class="font-bold">Neutra ‚û°Ô∏è - R$ 655.250,50</span>
                        </li>
                        <li title="√çndice de For√ßa Relativa (0-100, <30 sobrevendido, >70 sobrecomprado)"
                            class="p-1 rounded">
                            RSI: <span id="rsi">33.22 ‚úÖ</span>
                        </li>
                        <li title="M√©dia M√≥vel Exponencial de curto prazo (8 per√≠odos)" class="p-1 rounded">
                            EMA Curta: <span id="emaShort">R$ 655.200,77</span>
                        </li>
                        <li title="M√©dia M√≥vel Exponencial de longo prazo (20 per√≠odos)" class="p-1 rounded">
                            EMA Longa: <span id="emaLong">R$ 655.031,24</span>
                        </li>
                        <li title="Diferen√ßa entre EMAs de 12 e 26 per√≠odos" class="p-1 rounded">
                            MACD: <span id="macd">382.09</span>
                        </li>
                        <li title="M√©dia M√≥vel do MACD (9 per√≠odos, valor at√≠pico pode indicar erro nos dados)"
                            class="p-1 rounded pulse-orange">
                            Signal: <span id="signal">655197.65 ‚ö†Ô∏è</span>
                        </li>
                    </ul>
                </div>
                <!-- Vi√©s e Performance -->
                <div>
                    <h3 class="text-sm font-semibold mb-2 text-gray-300">Vi√©s e Performance</h3>
                    <ul class="space-y-1 text-xs sm:text-sm">
                        <li title="Probabilidade de lucro estimada (0 a 1)" class="p-1 rounded pulse-green">
                            Score Lucro Esperado: <span id="expectedProfitScore">1.00 ‚úÖ</span>
                        </li>
                        <li title="Confian√ßa na previs√£o de tend√™ncia (0 a 1)" class="p-1 rounded pulse-green">
                            Confian√ßa: <span id="confidence">1.00 ‚úÖ</span>
                        </li>
                        <li title="Ajuste de pre√ßo com base no saldo de BTC" class="p-1 rounded">
                            Vi√©s Invent√°rio: <span id="inventoryBias">0.000013</span>
                        </li>
                        <li title="Ajuste de pre√ßo com base na tend√™ncia do mercado" class="p-1 rounded">
                            Vi√©s Tend√™ncia: <span id="trendBias">-0.026300</span>
                        </li>
                        <li title="Combina√ß√£o de vi√©s de invent√°rio e tend√™ncia" class="p-1 rounded">
                            Total Bias: <span id="totalBias">-0.010000</span>
                        </li>
                    </ul>
                </div>
                <!-- Posi√ß√£o e Resultados -->
                <div>
                    <h3 class="text-sm font-semibold mb-2 text-gray-300">Posi√ß√£o e Resultados</h3>
                    <ul class="space-y-1 text-xs sm:text-sm">
                        <li title="Lucro/preju√≠zo n√£o realizado da posi√ß√£o atual" class="p-1 rounded pulse-green">
                            PnL N√£o Realizado: <span id="unrealizedPnl">R$ 0.00 üìà</span>
                        </li>
                        <li title="Quantidade de BTC em posi√ß√£o" class="p-1 rounded">
                            Posi√ß√£o BTC: <span id="btcPosition">0.00002000 BTC</span>
                        </li>
                        <li title="Percentual de ordens executadas com sucesso" class="p-1 rounded pulse-green">
                            Taxa de Fill: <span id="fillRate">24.0% ‚úÖ</span>
                        </li>
                        <li title="Pre√ßo m√©dio das ordens executadas" class="p-1 rounded">
                            Pre√ßo M√©dio Fill: <span id="avgFillPrice">R$ 654.259,13</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const priceHistory = [];
    let pnlChart;

    // Initialize chart first
    document.addEventListener('DOMContentLoaded', () => {
        pnlChart = new Chart(document.getElementById('pnlChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: "PnL (R$)",
                        borderColor: "#4ade80",
                        backgroundColor: "rgba(74,222,128,0.2)",
                        fill: true,
                        data: [],
                        tension: 0.3,
                        pointRadius: 2,
                        yAxisID: 'y'
                    },
                    {
                        label: "BTC Price (R$)",
                        borderColor: "#60a5fa",
                        backgroundColor: "rgba(96,165,250,0.2)",
                        fill: true,
                        data: [],
                        tension: 0.3,
                        pointRadius: 2,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {legend: {display: true, position: 'top'}, tooltip: {mode: 'index', intersect: false}},
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: {display: true, text: 'PnL (R$)'},
                        ticks: {font: {size: 10}}
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        title: {display: true, text: 'BTC Price (R$)'},
                        grid: {drawOnChartArea: false},
                        ticks: {font: {size: 10}}
                    },
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            tooltipFormat: 'HH:mm:ss',
                            displayFormats: {
                                second: 'HH:mm:ss'
                            }
                        },
                        title: {display: true, text: 'Hora'},
                        ticks: {font: {size: 10}}
                    }
                }
            }
        });
    });

    function formatSpread(spread) {
        if (!spread && spread !== 0) return "Sem dados";
        const value = Number(spread).toFixed(2);
        let level = "";
        if (spread < 0.5) level = " (muito baixo) ‚úÖ";
        else if (spread < 1.5) level = " (moderado) üòê";
        else level = " (alto) ‚ö†Ô∏è";
        return `${value}%${level}`;
    }

    function formatVolatility(vol) {
        if (!vol && vol !== 0) return "Sem dados";
        const value = Number(vol).toFixed(2);
        let desc = "";
        if (vol < 0.5) desc = " (est√°vel) ‚úÖ";
        else if (vol < 1.5) desc = " (moderada) üòê";
        else desc = " (alta) ‚ö†Ô∏è";
        return `${value}%${desc}`;
    }

    async function loadData() {
        try {
            const res = await fetch('/api/status');
            const data = await res.json();

            // Safely access data fields
            const modeSpan = document.getElementById('mode');
            modeSpan.textContent = `Modo: ${data.config?.simulate ? 'Simula√ß√£o' : 'Live'}`;
            modeSpan.className = data.config?.simulate
                ? 'px-2 py-1 sm:px-3 sm:py-1 bg-yellow-600 rounded-full text-xs sm:text-sm'
                : 'px-2 py-1 sm:px-3 sm:py-1 bg-green-600 rounded-full text-xs sm:text-sm';

            // Update cards
            const lastPrice = parseFloat(data.market?.last) || 654973.00;
            document.getElementById('lastPrice').textContent = `R$ ${lastPrice.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;

            document.getElementById('spread').textContent = formatSpread(data.market?.spread || 0.06);
            document.getElementById('volatility').textContent = formatVolatility(data.market?.volatility || 0.26);

            const totalPnL = parseFloat(data.stats?.totalPnL || 0.05927);
            document.getElementById('pnl').textContent = `R$ ${totalPnL.toFixed(2)}` +
                (totalPnL >= 0 ? ' üìà' : ' üìâ');
            document.getElementById('pnl').className = `text-lg sm:text-xl font-bold ${totalPnL >= 0 ? 'text-green-400' : 'text-red-400'}`;
            document.getElementById('monthlyPnl').textContent = `Mensal: R$ ${parseFloat(data.stats?.monthlyPnL || 0.05732).toFixed(2)}`;

            // Update balances
            document.getElementById('brl').textContent = `R$ ${parseFloat(data.balances?.brl || 393.35).toFixed(2)}`;
            document.getElementById('btc').textContent = `${parseFloat(data.balances?.btc || 0.00032331).toFixed(8)} BTC`;
            document.getElementById('total').textContent = `R$ ${parseFloat(data.balances?.total || 605.11).toFixed(2)}`;
            document.getElementById('uptime').textContent = `${data.stats?.uptime || '23 minutos'}`;

            // Update orders table
            const tbody = document.getElementById('ordersTable');
            tbody.innerHTML = '';
            (data.activeOrders || []).forEach(order => {
                const age = order.ageSecMinHour || {ageHour: 0, ageMin: 0, ageSec: 0};
                const ageStr = `${String(age.ageHour).padStart(2, '0')}:${String(age.ageMin % 60).padStart(2, '0')}:${String(age.ageSec % 60).padStart(2, '0')}`;
                const priceFormatted = parseFloat(order.price || 0).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="${order.side === 'buy' ? 'text-green-400' : 'text-red-400'} p-1 sm:p-2">${order.side || '--'}</td>
                    <td class="p-1 sm:p-2">${order.id || '--'}</td>
                    <td class="p-1 sm:p-2">R$ ${priceFormatted}</td>
                    <td class="p-1 sm:p-2">${parseFloat(order.qty || 0).toFixed(6)}</td>
                    <td class="p-1 sm:p-2">${order.status || '--'}</td>
                    <td class="p-1 sm:p-2">${order.drift || '--'}</td>
                    <td class="p-1 sm:p-2">${ageStr}</td>
                `;
                tbody.appendChild(tr);
            });

            // Update chart
            if (pnlChart && data.stats?.pnlHistory?.length > 0 && data.stats?.pnlTimestamps?.length > 0) {
                const priceToUse = data.config?.simulate ? parseFloat(data.market?.tendency?.midPrice || 655250.50) : parseFloat(data.market?.last || 654973.00);
                // Filter out invalid PnL values
                const validPnLData = data.stats.pnlHistory
                    .map((val, i) => ({value: parseFloat(val), timestamp: data.stats.pnlTimestamps[i]}))
                    .filter(item => !isNaN(item.value) && item.value < 1e10); // Remove outliers
                if (pnlChart.data.labels.length === 0) {
                    pnlChart.data.labels = validPnLData.map(item => new Date(item.timestamp));
                    pnlChart.data.datasets[0].data = validPnLData.map(item => ({
                        x: new Date(item.timestamp),
                        y: item.value
                    }));
                    pnlChart.data.datasets[1].data = validPnLData.map(item => ({
                        x: new Date(item.timestamp),
                        y: priceToUse
                    }));
                } else {
                    const lastTimestamp = pnlChart.data.labels[pnlChart.data.labels.length - 1];
                    const newTimestamp = new Date(data.timestamp);
                    if (!lastTimestamp || (newTimestamp - lastTimestamp) >= 60000) { // Update every 60s
                        const lastValidPnL = validPnLData.length > 0 ? validPnLData[validPnLData.length - 1].value : parseFloat(data.stats.totalPnL || 0.05927);
                        pnlChart.data.labels.push(newTimestamp);
                        pnlChart.data.datasets[0].data.push({
                            x: newTimestamp,
                            y: lastValidPnL
                        });
                        pnlChart.data.datasets[1].data.push({x: newTimestamp, y: priceToUse});
                    }
                }

                if (pnlChart.data.labels.length > 40) { // Keep 60 points (~4h at 60s intervals)
                    pnlChart.data.labels.shift();
                    pnlChart.data.datasets[0].data.shift();
                    pnlChart.data.datasets[1].data.shift();
                }
                pnlChart.update();
            }

            // Update config & trend
            document.getElementById('orderSize').textContent = data.config?.orderSize
                ? `${data.config.orderSize} BTC (~R$ ${(data.config.orderSize * (data.market?.tendency?.midPrice || data.market?.last || 655250.50)).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })})`
                : '0.000095 BTC (~R$ 62,25)';
            document.getElementById('orderSize').parentElement.className = 'p-1 rounded pulse-green';
            document.getElementById('targetSpread').textContent = data.config?.spreadPct
                ? `${(data.config.spreadPct * 100).toFixed(2)}% ${data.config.spreadPct < 0.01 ? '‚úÖ' : data.config.spreadPct < 0.02 ? 'üòê' : '‚ö†Ô∏è'}`
                : '0.07% ‚úÖ';
            document.getElementById('targetSpread').parentElement.className = 'p-1 rounded pulse-green';
            document.getElementById('cycleSec').textContent = `${data.config?.cycleSec || 15}s`;
            document.getElementById('stopLoss').textContent = data.config?.stopLoss
                ? `${(data.config.stopLoss * 100).toFixed(2)}%`
                : '0.80%';
            document.getElementById('takeProfit').textContent = data.config?.takeProfit
                ? `${(data.config.takeProfit * 100).toFixed(2)}%`
                : '2.00%';
            document.getElementById('minVolume').textContent = data.config?.minVolume
                ? `${data.config.minVolume} BTC`
                : '0.00005 BTC';
            document.getElementById('volatilityLimit').textContent = data.config?.volatilityLimit
                ? `${(data.config.volatilityLimit * 100).toFixed(2)}%`
                : '5.00%';
            document.getElementById('rsi').textContent = data.market?.tendency?.rsi
                ? `${parseFloat(data.market.tendency.rsi).toFixed(2)} ${data.market.tendency.rsi >= 30 && data.market.tendency.rsi <= 70 ? '‚úÖ' : '‚ö†Ô∏è'}`
                : '33.22 ‚úÖ';
            document.getElementById('rsi').parentElement.className = data.market?.tendency?.rsi && (data.market.tendency.rsi >= 30 && data.market.tendency.rsi <= 70) ? 'p-1 rounded pulse-green' : 'p-1 rounded';
            document.getElementById('emaShort').textContent = data.market?.tendency?.emaShort
                ? `R$ ${parseFloat(data.market.tendency.emaShort).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`
                : 'R$ 655.200,77';
            document.getElementById('emaLong').textContent = data.market?.tendency?.emaLong
                ? `R$ ${parseFloat(data.market.tendency.emaLong).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`
                : 'R$ 655.031,24';
            document.getElementById('macd').textContent = data.market?.tendency?.macd
                ? parseFloat(data.market.tendency.macd).toFixed(2)
                : '382.09';
            document.getElementById('signal').textContent = data.market?.tendency?.signal
                ? `${parseFloat(data.market.tendency.signal).toFixed(2)} ${Math.abs(data.market.tendency.signal) > 1000 ? '‚ö†Ô∏è' : '‚úÖ'}`
                : '655197.65 ‚ö†Ô∏è';
            document.getElementById('signal').parentElement.className = data.market?.tendency?.signal && Math.abs(data.market.tendency.signal) > 1000 ? 'p-1 rounded pulse-orange' : 'p-1 rounded pulse-green';
            document.getElementById('expectedProfitScore').textContent = data.stats?.expectedProfitScore
                ? `${parseFloat(data.stats.expectedProfitScore).toFixed(2)} ${data.stats.expectedProfitScore >= 0.1 ? '‚úÖ' : '‚ö†Ô∏è'}`
                : '1.00 ‚úÖ';
            document.getElementById('expectedProfitScore').parentElement.className = 'p-1 rounded pulse-green';
            document.getElementById('confidence').textContent = data.market?.tendency?.confidence
                ? `${parseFloat(data.market.tendency.confidence).toFixed(2)} ${data.market.tendency.confidence >= 0.5 ? '‚úÖ' : '‚ö†Ô∏è'}`
                : '1.00 ‚úÖ';
            document.getElementById('confidence').parentElement.className = 'p-1 rounded pulse-green';
            document.getElementById('inventoryBias').textContent = data.stats?.inventoryBias
                ? parseFloat(data.stats.inventoryBias).toFixed(6)
                : '0.000013';
            document.getElementById('trendBias').textContent = data.stats?.trendBias
                ? parseFloat(data.stats.trendBias).toFixed(6)
                : '-0.026300';
            document.getElementById('totalBias').textContent = data.stats?.totalBias
                ? parseFloat(data.stats.totalBias).toFixed(6)
                : '-0.010000';
            document.getElementById('unrealizedPnl').textContent = data.stats?.unrealizedPnl
                ? `R$ ${parseFloat(data.stats.unrealizedPnl).toFixed(2)} ${data.stats.unrealizedPnl > 0 ? 'üìà' : data.stats.unrealizedPnl < 0 ? 'üìâ' : 'üòê'}`
                : 'R$ 0.00 üìà';
            document.getElementById('unrealizedPnl').parentElement.className = data.stats?.unrealizedPnl && data.stats.unrealizedPnl < 0 ? 'p-1 rounded pulse-orange' : 'p-1 rounded pulse-green';
            document.getElementById('btcPosition').textContent = data.stats?.btcPosition
                ? `${parseFloat(data.stats.btcPosition).toFixed(8)} BTC`
                : '0.00002000 BTC';
            document.getElementById('fillRate').textContent = data.stats?.fillRate
                ? `${data.stats.fillRate} ${data.stats.fillRate.replace('%', '') >= 20 ? '‚úÖ' : '‚ö†Ô∏è'}`
                : '24.0% ‚úÖ';
            document.getElementById('fillRate').parentElement.className = 'p-1 rounded pulse-green';
            document.getElementById('avgFillPrice').textContent = data.stats?.avgFillPrice
                ? `R$ ${parseFloat(data.stats.avgFillPrice).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`
                : 'R$ 654.259,13';

            // Update trend
            const trendEl = document.getElementById('trend');
            const priceToUse = data.config?.simulate ? parseFloat(data.market?.tendency?.midPrice || 655250.50) : parseFloat(data.market?.last || 654973.00);
            if (data.market?.tendency?.trend === 'up') {
                trendEl.textContent = `Alta üìà - R$ ${priceToUse.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
                trendEl.className = "text-green-400 font-bold";
                trendEl.parentElement.className = 'p-1 rounded pulse-green';
            } else if (data.market?.tendency?.trend === 'down') {
                trendEl.textContent = `Baixa üìâ - R$ ${priceToUse.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
                trendEl.className = "text-red-400 font-bold";
                trendEl.parentElement.className = 'p-1 rounded pulse-orange';
            } else {
                trendEl.textContent = `Neutra ‚û°Ô∏è - R$ ${priceToUse.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
                trendEl.className = "text-gray-400 font-bold";
                trendEl.parentElement.className = 'p-1 rounded';
            }

        } catch (error) {
            console.error('Error loading data:', error);
        }
    }

    setInterval(loadData, 10 * 1000);
    loadData();
</script>
</body>
</html>