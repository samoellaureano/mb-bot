<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MB Bot Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        @keyframes pulse-green {
            0% {
                background-color: rgba(74, 222, 128, 0.1);
            }
            50% {
                background-color: rgba(74, 222, 128, 0.3);
            }
            100% {
                background-color: rgba(74, 222, 128, 0.1);
            }
        }

        @keyframes pulse-orange {
            0% {
                background-color: rgba(251, 146, 60, 0.1);
            }
            50% {
                background-color: rgba(251, 146, 60, 0.3);
            }
            100% {
                background-color: rgba(251, 146, 60, 0.1);
            }
        }

        .pulse-green {
            animation: pulse-green 2s infinite;
        }

        .pulse-orange {
            animation: pulse-orange 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">
<div class="container mx-auto p-4">
    <div class="flex justify-between items-center mb-4">
        <h1 class="text-xl sm:text-2xl font-bold">üìä MB Bot Dashboard</h1>
        <span id="mode" class="px-2 py-1 sm:px-3 sm:py-1 bg-green-600 rounded-full text-xs sm:text-sm">Modo: Live</span>
    </div>
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow border-l-4 border-blue-500">
            <p class="text-gray-400 text-xs sm:text-sm">√öltimo Pre√ßo</p>
            <h2 id="lastPrice" class="text-lg sm:text-xl font-bold">Carregando...</h2>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow border-l-4 border-yellow-500">
            <p class="text-gray-400 text-xs sm:text-sm">Spread / Volatilidade</p>
            <h2 id="spread" class="text-lg sm:text-xl font-bold">--</h2>
            <p id="volatility" class="text-xs sm:text-sm text-gray-400">Vol: --</p>
        </div>
        <div id="pnlCard" class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow border-l-4 border-gray-500">
            <p class="text-gray-400 text-xs sm:text-sm">Lucro Total (PnL)</p>
            <h2 id="pnl" class="text-lg sm:text-xl font-bold">R$ 0,00</h2>
            <p id="roi" class="text-xs sm:text-sm text-gray-400">ROI: 0,00%</p>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow border-l-4 border-purple-500">
            <p class="text-gray-400 text-xs sm:text-sm">Saldo Total Est.</p>
            <h2 id="totalBalanceCard" class="text-lg sm:text-xl font-bold">Carregando...</h2>
            <p id="monthlyPnl" class="text-xs sm:text-sm text-gray-400">Mensal: R$ 0,00</p>
        </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-2">Saldos</h2>
            <ul class="space-y-1 text-xs sm:text-sm">
                <li>BRL: <span id="brl">Carregando...</span></li>
                <li>BTC: <span id="btc">Carregando...</span></li>
                <li>Total: <span id="totalBalanceList">Carregando...</span></li>
            </ul>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow md:col-span-3">
            <h2 class="text-base sm:text-lg font-bold mb-2">Ordens Ativas</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-xs sm:text-sm">
                    <thead>
                    <tr class="text-gray-400">
                        <th class="text-left p-1 sm:p-2">Side</th>
                        <th class="text-left p-1 sm:p-2">ID</th>
                        <th class="text-left p-1 sm:p-2">Pair ID</th>
                        <th class="text-left p-1 sm:p-2">Pre√ßo</th>
                        <th class="text-left p-1 sm:p-2">Qtd</th>
                        <th class="text-left p-1 sm:p-2">Status</th>
                        <th class="text-left p-1 sm:p-2">Exchange</th>
                        <th class="text-left p-1 sm:p-2">Drift</th>
                        <th class="text-left p-1 sm:p-2">Age</th>
                    </tr>
                    </thead>
                    <tbody id="ordersTable">
                    <tr>
                        <td class="text-red-400 p-1 sm:p-2">sell</td>
                        <td class="p-1 sm:p-2">01K70C1BRYAXM0PD92BRESXN7A</td>
                        <td class="p-1 sm:p-2">R$ 655.532,00</td>
                        <td class="p-1 sm:p-2">0.000020</td>
                        <td class="p-1 sm:p-2">working</td>
                        <td class="p-1 sm:p-2">0.05%</td>
                        <td class="p-1 sm:p-2">00:04:19</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- SE√á√ÉO DE PARES BUY/SELL -->
    <div class="mt-4 bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-base sm:text-lg font-bold">üîó Rastreamento de Pares BUY/SELL</h2>
            <span id="pairsRefreshBadge" class="text-xs px-2 py-1 bg-gray-700 rounded text-gray-300">Atualizando...</span>
        </div>
        
        <!-- Resumo de Pares -->
        <div class="grid grid-cols-1 sm:grid-cols-4 gap-2 mb-4">
            <div class="bg-gray-700 p-3 rounded-lg text-center">
                <div class="text-2xl font-bold text-blue-400" id="totalPairsCount">0</div>
                <div class="text-xs text-gray-400 mt-1">Total de Pares</div>
            </div>
            <div class="bg-gray-700 p-3 rounded-lg text-center">
                <div class="text-2xl font-bold text-green-400" id="completePairsCount">0</div>
                <div class="text-xs text-gray-400 mt-1">Pares Completos</div>
            </div>
            <div class="bg-gray-700 p-3 rounded-lg text-center">
                <div class="text-2xl font-bold text-yellow-400" id="incompletePairsCount">0</div>
                <div class="text-xs text-gray-400 mt-1">Incompletos</div>
            </div>
            <div class="bg-gray-700 p-3 rounded-lg text-center">
                <div class="text-2xl font-bold text-orange-400" id="avgPairRoi">0.00%</div>
                <div class="text-xs text-gray-400 mt-1">ROI M√©dio</div>
            </div>
        </div>

        <!-- Tabela de Pares -->
        <div class="overflow-x-auto">
            <table class="w-full text-xs">
                <thead>
                <tr class="text-gray-400 border-b border-gray-700">
                    <th class="text-left p-2">Pair ID</th>
                    <th class="text-left p-2">Status</th>
                    <th class="text-center p-2">BUY</th>
                    <th class="text-center p-2">SELL</th>
                    <th class="text-right p-2">Spread</th>
                    <th class="text-right p-2">ROI L√≠quido</th>
                </tr>
                </thead>
                <tbody id="pairsTableBody">
                <tr>
                    <td class="p-2 text-gray-400 text-center" colspan="6">Carregando pares...</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
        <!-- Gr√°fico de PnL -->
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-2" style="color: #10b981;">üìà Evolu√ß√£o do PnL (R$)</h2>
            <div class="w-full h-64 sm:h-72">
                <canvas id="pnlChart"></canvas>
            </div>
        </div>
        
        <!-- Gr√°fico de BTC Price -->
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-2" style="color: #3b82f6;">üí∞ Pre√ßo BTC (R$)</h2>
            <div class="w-full h-64 sm:h-72">
                <canvas id="btcChart"></canvas>
            </div>
        </div>
        
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow" id="recoveryMonitorContainer" style="display:none;">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <h2 class="text-base sm:text-lg font-bold" style="color: #fbbf24;">Monitor de Recupera√ß√£o (PnL Residual)</h2>
                    <span id="baselineBadge" class="hidden text-xs px-2 py-1 rounded-full bg-yellow-700 text-yellow-200">Baseline atualizado</span>
                </div>
                <button id="resetBaselineBtn" class="text-xs px-2 py-1 bg-gray-600 hover:bg-gray-500 rounded text-gray-300 transition" title="Resetar ponto de refer√™ncia">‚Üª Reset</button>
            </div>
            
            <!-- Barra de Progresso para Meta -->
            <div class="mb-4 p-3 bg-gray-700 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-semibold text-gray-300">Progresso para Break-Even:</span>
                    <span id="recoveryPercentage" class="text-lg font-bold text-yellow-400">0%</span>
                </div>
                <div class="w-full bg-gray-600 rounded-full h-6 overflow-hidden">
                    <div id="recoveryProgressBar" class="bg-gradient-to-r from-red-500 to-yellow-400 h-6 rounded-full transition-all duration-500" style="width: 0%;">
                        <span id="recoveryProgressText" class="absolute ml-2 text-xs font-bold text-gray-900 h-6 flex items-center" style="display: none;">0%</span>
                    </div>
                </div>
                <div class="flex justify-between text-xs text-gray-400 mt-2">
                    <span>Perda Atual: <strong id="recoveryLoss">-R$ 5,34</strong></span>
                    <span>Meta: <strong>R$ 0,00</strong></span>
                </div>
                <div class="text-xs text-gray-500 mt-1">
                    <span>Baseline: <strong id="recoveryBaseline">-R$ 5,34</strong></span>
                </div>
            </div>
            
            <div class="w-full h-64 sm:h-72">
                <canvas id="residualPnlChart"></canvas>
            </div>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-4">Config & Tend√™ncia</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <h3 class="text-sm font-semibold mb-2 text-gray-300">Configura√ß√µes do Bot</h3>
                    <ul class="space-y-1 text-xs sm:text-sm">
                        <li title="Tamanho m√≠nimo de cada ordem em BTC" class="p-1 rounded pulse-green">
                            Ordem size: <span id="orderSize">0.00005 BTC (~R$ 32,75)</span>
                        </li>
                        <li title="Percentual alvo de diferen√ßa entre compra e venda" class="p-1 rounded pulse-green">
                            Spread alvo: <span id="targetSpread">0.02% ‚úÖ</span>
                        </li>
                        <li title="Intervalo entre ciclos de decis√£o do bot" class="p-1 rounded">
                            Intervalo ciclo: <span id="cycleSec">15s</span>
                        </li>
                        <li title="Limite de perda para cancelar ordens" class="p-1 rounded">
                            Stop-Loss: <span id="stopLoss">0.80%</span>
                        </li>
                        <li title="Meta de lucro para realizar ganhos" class="p-1 rounded">
                            Take-Profit: <span id="takeProfit">2.00%</span>
                        </li>
                        <li title="Volume m√≠nimo para ordens serem v√°lidas" class="p-1 rounded">
                            Volume M√≠nimo: <span id="minVolume">0.00005 BTC</span>
                        </li>
                        <li title="Limite m√°ximo de volatilidade para operar" class="p-1 rounded">
                            Limite de Volatilidade: <span id="volatilityLimit">3.50%</span>
                        </li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold mb-2 text-gray-300">Indicadores T√©cnicos</h3>
                    <ul class="space-y-1 text-xs sm:text-sm">
                        <li title="Tend√™ncia do mercado com base em indicadores" class="p-1 rounded">
                                    Tend√™ncia: <span id="trend">Neutra ‚û°Ô∏è - R$ 654.973,00</span>
                        </li>
                        <li title="Regime de mercado atual" class="p-1 rounded">
                            Regime: <span id="regime" class="font-bold">NEUTRAL</span>
                        </li>     </li>
                        <li title="√çndice de For√ßa Relativa (0-100, <30 sobrevendido, >70 sobrecomprado)"
                            class="p-1 rounded">
                            RSI: <span id="rsi">33.22 ‚úÖ</span>
                        </li>
                        <li title="M√©dia M√≥vel Exponencial de curto prazo (8 per√≠odos)" class="p-1 rounded">
                            EMA Curta: <span id="emaShort">R$ 655.200,77</span>
                        </li>
                        <li title="M√©dia M√≥vel Exponencial de longo prazo (20 per√≠odos)" class="p-1 rounded">
                            EMA Longa: <span id="emaLong">R$ 655.031,24</span>
                        </li>
                        <li title="Diferen√ßa entre EMAs de 12 e 26 per√≠odos" class="p-1 rounded">
                            MACD: <span id="macd">382.09</span>
                        </li>
                        <li title="M√©dia M√≥vel do MACD (9 per√≠odos)" class="p-1 rounded pulse-green">
                            Signal: <span id="signal">382.09 ‚úÖ</span>
                        </li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold mb-2 text-gray-300">Valida√ß√£o Externa üì°</h3>
                    <ul class="space-y-1 text-xs sm:text-sm">
                        <li title="Alinhamento entre an√°lise do bot e tend√™ncias externas" id="alignmentStatus" class="p-1 rounded">
                            Status: <span id="alignment">Carregando...</span>
                        </li>
                        <li title="Tend√™ncia calculada por fontes externas" class="p-1 rounded">
                            Tend√™ncia Externa: <span id="externalTrend">--</span>
                        </li>
                        <li title="Confian√ßa da an√°lise externa (0 a 1)" class="p-1 rounded">
                            Confian√ßa Externa: <span id="externalConfidence">--</span>
                        </li>
                        <li title="Score da tend√™ncia externa (-1 a 1)" class="p-1 rounded">
                            Score: <span id="externalScore">--</span>
                        </li>
                        <li title="Status das fontes de dados externas" class="p-1 rounded">
                            Fontes: <span id="externalSources">--</span>
                        </li>
                        <li title="Compara√ß√£o das an√°lises Bot vs External" class="p-1 rounded">
                            Bot vs Externo: <span id="botVsExternal">--</span>
                        </li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold mb-2 text-gray-300">Vi√©s e Performance</h3>
                    <ul class="space-y-1 text-xs sm:text-sm">
                        <li title="Probabilidade de lucro estimada (0 a 1)" class="p-1 rounded pulse-green">
                            Score Lucro Esperado: <span id="expectedProfitScore">1.00 ‚úÖ</span>
                        </li>
                        <li title="Confian√ßa na previs√£o de tend√™ncia (0 a 1)" class="p-1 rounded pulse-green">
                            Confian√ßa: <span id="confidence">1.00 ‚úÖ</span>
                        </li>
                        <li title="Ajuste de pre√ßo com base no saldo de BTC" class="p-1 rounded">
                            Vi√©s Invent√°rio: <span id="inventoryBias">0.000013</span>
                        </li>
                        <li title="Ajuste de pre√ßo com base na tend√™ncia do mercado" class="p-1 rounded">
                            Vi√©s Tend√™ncia: <span id="trendBias">-0.026300</span>
                        </li>
                        <li title="Combina√ß√£o de vi√©s de invent√°rio e tend√™ncia" class="p-1 rounded">
                            Total Bias: <span id="totalBias">-0.010000</span>
                        </li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold mb-2 text-gray-300">Posi√ß√£o e Resultados</h3>
                    <ul class="space-y-1 text-xs sm:text-sm">
                        <li title="Lucro/preju√≠zo n√£o realizado da posi√ß√£o atual" class="p-1 rounded pulse-green">
                            PnL N√£o Realizado: <span id="unrealizedPnl">R$ 0.00 üìà</span>
                        </li>
                        <li title="Quantidade de BTC em posi√ß√£o" class="p-1 rounded">
                            Posi√ß√£o BTC: <span id="btcPosition">0.00002000 BTC</span>
                        </li>
                        <li title="Percentual de ordens executadas com sucesso" class="p-1 rounded pulse-green">
                            Taxa de Fill: <span id="fillRate">24.0% ‚úÖ</span>
                        </li>
                        <li title="Pre√ßo m√©dio das ordens executadas" class="p-1 rounded">
                            Pre√ßo M√©dio Fill: <span id="avgFillPrice">R$ 654.259,13</span>
                        </li>
                        <li title="Tempo de atividade do bot" class="p-1 rounded pulse-green">
                            Uptime: <span id="uptime">23 minutos</span>
                        </li>
                        <li title="Retorno sobre investimento (ROI)" class="p-1 rounded pulse-green">
                            ROI: <span id="roi">0.01% üìà</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const priceHistory = [];
    let pnlChart;
    let btcChart;
    let residualPnlChart;

    document.addEventListener('DOMContentLoaded', () => {
        // Gr√°fico de PnL (apenas linha verde do PnL)
        pnlChart = new Chart(document.getElementById('pnlChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: "PnL (R$)",
                        borderColor: "#10b981",
                        backgroundColor: "rgba(16,185,129,0.1)",
                        borderWidth: 2.5,
                        fill: true,
                        data: [],
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointBackgroundColor: "#10b981",
                        pointBorderColor: "#ffffff",
                        pointBorderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {mode: 'index', intersect: false},
                plugins: {
                    legend: {display: true, position: 'top', labels: {color: '#9ca3af', font: {size: 11}}},
                    tooltip: {
                        backgroundColor: 'rgba(17, 24, 39, 0.9)',
                        titleColor: '#f3f4f6',
                        bodyColor: '#d1d5db',
                        borderColor: '#10b981',
                        borderWidth: 2,
                        padding: 10,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) {
                                    const value = context.parsed.y;
                                    const color = value >= 0 ? '#10b981' : '#ef4444';
                                    label += (value >= 0 ? '+' : '') + 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        position: 'right',
                        title: {display: true, text: 'PnL (R$)', color: '#10b981', font: {weight: 'bold'}},
                        grid: {color: 'rgba(75, 85, 99, 0.1)'},
                        ticks: {color: '#9ca3af', font: {size: 11}, callback: function(value) {
                            return (value >= 0 ? '+' : '') + 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        }}
                    },
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            displayFormats: {minute: 'HH:mm'}
                        },
                        grid: {color: 'rgba(75, 85, 99, 0.1)'},
                        ticks: {color: '#9ca3af', font: {size: 10}}
                    }
                }
            }
        });

        // Gr√°fico de BTC Price (apenas linha azul do pre√ßo)
        btcChart = new Chart(document.getElementById('btcChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: "BTC Price (R$)",
                        borderColor: "#3b82f6",
                        backgroundColor: "rgba(59,130,246,0.1)",
                        borderWidth: 2.5,
                        fill: true,
                        data: [],
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointBackgroundColor: "#3b82f6",
                        pointBorderColor: "#ffffff",
                        pointBorderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {mode: 'index', intersect: false},
                plugins: {
                    legend: {display: true, position: 'top', labels: {color: '#9ca3af', font: {size: 11}}},
                    tooltip: {
                        backgroundColor: 'rgba(17, 24, 39, 0.9)',
                        titleColor: '#f3f4f6',
                        bodyColor: '#d1d5db',
                        borderColor: '#3b82f6',
                        borderWidth: 2,
                        padding: 10,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) {
                                    label += 'R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        position: 'right',
                        title: {display: true, text: 'BTC Price (R$)', color: '#3b82f6', font: {weight: 'bold'}},
                        grid: {color: 'rgba(75, 85, 99, 0.1)'},
                        ticks: {color: '#9ca3af', font: {size: 11}, callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        }}
                    },
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            displayFormats: {minute: 'HH:mm'}
                        },
                        grid: {color: 'rgba(75, 85, 99, 0.1)'},
                        ticks: {color: '#9ca3af', font: {size: 10}}
                    }
                }
            }
        });
    });

    function formatSpread(spread) {
        if (!spread && spread !== 0) return "Sem dados";
        const value = Number(spread).toFixed(2);
        let level = "";
        if (spread < 0.5) level = " (muito baixo) ‚úÖ";
        else if (spread < 1.5) level = " (moderado) üòê";
        else level = " (alto) ‚ö†Ô∏è";
        return `${value}%${level}`;
    }

    function formatVolatility(vol) {
        if (!vol && vol !== 0) return "Sem dados";
        const value = Number(vol).toFixed(2);
        let desc = "";
        if (vol < 0.5) desc = " (est√°vel) ‚úÖ";
        else if (vol < 1.5) desc = " (moderada) üòê";
        else desc = " (alta) ‚ö†Ô∏è";
        return `${value}%${desc}`;
    }

    async function loadData() {
        try {
            console.log('[Dashboard] Fetching data from API...');
            const res = await fetch(`/api/data?t=${Date.now()}`);
            const data = await res.json();
            console.log('[Dashboard] Data loaded:', {
                roi: data.stats?.roi,
                totalPnL: data.stats?.totalPnL,
                balanceTotal: data.balances?.total
            });

            const modeSpan = document.getElementById('mode');
            modeSpan.textContent = `Modo: ${data.config?.simulate ? 'Simula√ß√£o' : 'Live'}`;
            modeSpan.className = data.config?.simulate
                ? 'px-2 py-1 sm:px-3 sm:py-1 bg-yellow-600 rounded-full text-xs sm:text-sm'
                : 'px-2 py-1 sm:px-3 sm:py-1 bg-green-600 rounded-full text-xs sm:text-sm';

            const lastPrice = parseFloat(data.market?.last) || 654973.00;
            document.getElementById('lastPrice').textContent = `R$ ${lastPrice.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;

            document.getElementById('spread').textContent = formatSpread(data.market?.spread || 0.06);
            document.getElementById('volatility').textContent = formatVolatility(data.market?.volatility || 0.26);

            const totalPnL = parseFloat(data.stats?.totalPnL || 0);
            const pnlEl = document.getElementById('pnl');
            const pnlCard = document.getElementById('pnlCard');
            
            console.log('[Dashboard] PnL updating: ', totalPnL);
            
            pnlEl.textContent = `R$ ${totalPnL.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })} ${totalPnL > 0 ? 'üìà' : totalPnL < 0 ? 'üìâ' : 'üòê'}`;
            
            // Atualizar cor da borda do card PnL dinamicamente (sempre vis√≠vel)
            if (totalPnL > 0) {
                pnlEl.className = "text-green-400 text-lg sm:text-xl font-bold";
                pnlCard.classList.remove('border-red-500', 'border-gray-500');
                pnlCard.classList.add('border-green-500');
            } else if (totalPnL < 0) {
                pnlEl.className = "text-red-400 text-lg sm:text-xl font-bold";
                pnlCard.classList.remove('border-green-500', 'border-gray-500');
                pnlCard.classList.add('border-red-500');
            } else {
                pnlEl.className = "text-gray-400 text-lg sm:text-xl font-bold";
                pnlCard.classList.remove('border-green-500', 'border-red-500');
                pnlCard.classList.add('border-gray-500');
            }

            document.getElementById('monthlyPnl').textContent = `Mensal: R$ ${parseFloat(data.stats?.monthlyPnL || 0).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;

            document.getElementById('brl').textContent = `R$ ${parseFloat(data.balances?.brl || 0).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
            document.getElementById('btc').textContent = `${parseFloat(data.balances?.btc || 0).toFixed(8)} BTC`;
            const totalFormatted = `R$ ${parseFloat(data.balances?.total || 0).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
            document.getElementById('totalBalanceCard').textContent = totalFormatted;
            document.getElementById('totalBalanceList').textContent = totalFormatted;

            const tbody = document.getElementById('ordersTable');
            tbody.innerHTML = '';
            (data.activeOrders || []).forEach(order => {
                const age = order.ageSecMinHour || {ageHour: 0, ageMin: 0, ageSec: 0};
                const ageStr = `${String(age.ageHour).padStart(2, '0')}:${String(age.ageMin % 60).padStart(2, '0')}:${String(age.ageSec % 60).padStart(2, '0')}`;
                const priceFormatted = parseFloat(order.price || 0).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                const tr = document.createElement('tr');
                const pairId = order.pair_id ? order.pair_id : '‚ùå Sem par';
                
                // Status do Exchange: mostrar ID ou "Aguardando coloca√ß√£o"
                let exchangeStatusDisplay = '‚ùì';
                if (order.exchangeStatus && order.exchangeStatus.includes('Aguardando')) {
                    exchangeStatusDisplay = `<span class="text-yellow-400 animate-pulse">${order.exchangeStatus}</span>`;
                } else if (order.exchangeId) {
                    exchangeStatusDisplay = `<span class="text-green-400 font-mono text-xs">${order.exchangeId.substring(0, 12)}...</span>`;
                } else if (order.exchangeStatus && order.exchangeStatus !== 'N/A') {
                    exchangeStatusDisplay = `<span class="text-green-400 font-mono text-xs">${order.exchangeStatus.substring(0, 12)}...</span>`;
                } else {
                    exchangeStatusDisplay = '‚úÖ Ativa';
                }
                
                tr.innerHTML = `
                    <td class="${order.side === 'buy' ? 'text-green-400' : 'text-red-400'} p-1 sm:p-2">${order.side || '--'}</td>
                    <td class="p-1 sm:p-2 font-mono text-xs truncate">${order.id || '--'}</td>
                    <td class="p-1 sm:p-2 text-yellow-300 font-mono text-xs truncate">${pairId}</td>
                    <td class="p-1 sm:p-2">R$ ${priceFormatted}</td>
                    <td class="p-1 sm:p-2">${parseFloat(order.qty || '0').toFixed(8)}</td>
                    <td class="p-1 sm:p-2">${order.status || '--'}</td>
                    <td class="p-1 sm:p-2">${exchangeStatusDisplay}</td>
                    <td class="p-1 sm:p-2">${order.drift || '--'}</td>
                    <td class="p-1 sm:p-2">${ageStr}</td>
                `;
                tbody.appendChild(tr);
            });

            if (pnlChart && btcChart && data.stats?.pnlHistory?.length > 0 && data.stats?.pnlTimestamps?.length > 0) {
                const validPnLData = data.stats.pnlHistory
                    .map((val, i) => ({value: parseFloat(val), timestamp: data.stats.pnlTimestamps[i]}))
                    .filter(item => !isNaN(item.value) && item.value < 1e10 && item.timestamp);
                
                // Carregar hist√≥rico de pre√ßo BTC do servidor
                const validPriceData = (data.stats?.priceHistory || [])
                    .map((price, i) => ({price: parseFloat(price), timestamp: data.stats.priceTimestamps[i]}))
                    .filter(item => !isNaN(item.price) && item.timestamp);
                
                // IMPORTANTE: Sempre recarregar dados completos do servidor
                // Isso garante que ao fazer refresh, o hist√≥rico persista
                const shouldRebuildPnLChart = pnlChart.data.labels.length === 0;
                const shouldRebuildBtcChart = btcChart.data.labels.length === 0;
                
                if (shouldRebuildPnLChart) {
                    // Primeira carga ou depois do refresh: carregar todos os dados do PnL
                    pnlChart.data.labels = validPnLData.map(item => new Date(item.timestamp));
                    pnlChart.data.datasets[0].data = validPnLData.map(item => ({
                        x: new Date(item.timestamp),
                        y: item.value
                    }));
                    pnlChart.update();
                } else {
                    // Atualiza√ß√£o normal do PnL: apenas adiciona novo ponto
                    const lastTimestamp = pnlChart.data.labels[pnlChart.data.labels.length - 1];
                    const newTimestamp = new Date(data.timestamp);
                    if (!lastTimestamp || (newTimestamp - lastTimestamp) >= 60000) {
                        const lastValidPnL = validPnLData.length > 0 ? validPnLData[validPnLData.length - 1].value : parseFloat(data.stats.totalPnL || '0.06');
                        
                        pnlChart.data.labels.push(newTimestamp);
                        pnlChart.data.datasets[0].data.push({
                            x: newTimestamp,
                            y: lastValidPnL
                        });
                    }
                }
                
                // Manter apenas os √∫ltimos 60 pontos para performance (PnL)
                if (pnlChart.data.labels.length > 60) {
                    pnlChart.data.labels.shift();
                    pnlChart.data.datasets[0].data.shift();
                }
                pnlChart.update();
                
                // ===== GR√ÅFICO DE BTC PRICE =====
                if (shouldRebuildBtcChart) {
                    // Primeira carga: carregar hist√≥rico de pre√ßo
                    if (validPriceData.length > 0) {
                        btcChart.data.labels = validPriceData.map(item => new Date(item.timestamp));
                        btcChart.data.datasets[0].data = validPriceData.map(item => ({
                            x: new Date(item.timestamp),
                            y: item.price
                        }));
                    }
                    btcChart.update();
                } else {
                    // Atualiza√ß√£o normal: adiciona novo ponto
                    const lastTimestamp = btcChart.data.labels[btcChart.data.labels.length - 1];
                    const newTimestamp = new Date(data.timestamp);
                    if (!lastTimestamp || (newTimestamp - lastTimestamp) >= 60000) {
                        const currentPrice = validPriceData.length > 0 ? validPriceData[validPriceData.length - 1].price : parseFloat(data.market?.last || 490000);
                        
                        btcChart.data.labels.push(newTimestamp);
                        btcChart.data.datasets[0].data.push({
                            x: newTimestamp,
                            y: currentPrice
                        });
                    }
                }
                
                // Manter apenas os √∫ltimos 60 pontos para performance (BTC Price)
                if (btcChart.data.labels.length > 60) {
                    btcChart.data.labels.shift();
                    btcChart.data.datasets[0].data.shift();
                }
                btcChart.update();
            }

            // Monitor de Recupera√ß√£o - Mostrar sempre que PnL for negativo
            const recoveryContainer = document.getElementById('recoveryMonitorContainer');
            if (totalPnL < 0) {
                recoveryContainer.style.display = 'block';
                
                // ===== BASELINE DIN√ÇMICO GERENCIADO PELO SERVIDOR =====
                // O baseline √© SEMPRE o menor valor de PnL (mais negativo) registrado
                // O bot.js atualiza automaticamente quando PnL piora
                let recoveryBaseline = totalPnL; // Valor padr√£o se servidor falhar
                let recoveryPoints = [];
                
                try {
                    const recRes = await fetch(`/api/recovery?t=${Date.now()}`);
                    const recData = await recRes.json();
                    
                    if (recData && recData.activeSession && recData.activeSession.baseline !== undefined) {
                        // Usar baseline do servidor (sempre o menor valor registrado)
                        recoveryBaseline = parseFloat(recData.activeSession.baseline);
                        recoveryPoints = recData.points || [];
                        
                        // Detectar nova sess√£o para exibir badge
                        const prevSessionId = localStorage.getItem('lastRecoverySessionId');
                        if (!prevSessionId || String(prevSessionId) !== String(recData.activeSession.id)) {
                            const badge = document.getElementById('baselineBadge');
                            if (badge) {
                                badge.textContent = 'Nova recupera√ß√£o iniciada';
                                badge.classList.remove('hidden');
                                setTimeout(() => badge.classList.add('hidden'), 3000);
                            }
                            localStorage.setItem('lastRecoverySessionId', String(recData.activeSession.id));
                        }
                        
                        console.log(`‚úÖ Baseline do servidor: R$ ${recoveryBaseline.toFixed(2)} | Pontos: ${recoveryPoints.length}`);
                    } else {
                        console.log(`‚ö†Ô∏è Nenhuma sess√£o ativa no servidor, usando PnL atual como baseline: R$ ${recoveryBaseline.toFixed(2)}`);
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è Falha ao carregar sess√£o de recupera√ß√£o do servidor:', e?.message || e);
                }
                
                // Calcular porcentagem de recupera√ß√£o
                // Baseline √© SEMPRE o menor (mais negativo) valor registrado
                // Progresso = quanto recuperou do baseline at√© R$ 0,00
                // 0% = no baseline (pior momento), 100% = em R$ 0,00 (break-even)
                const percentageRecovered = recoveryBaseline < 0 
                    ? Math.max(0, Math.min(100, ((totalPnL - recoveryBaseline) / (0 - recoveryBaseline)) * 100))
                    : 0;
                
                document.getElementById('recoveryPercentage').textContent = percentageRecovered.toFixed(1) + '%';
                document.getElementById('recoveryProgressBar').style.width = percentageRecovered + '%';
                document.getElementById('recoveryLoss').textContent = `R$ ${totalPnL.toFixed(2)}`;
                document.getElementById('recoveryBaseline').textContent = `R$ ${recoveryBaseline.toFixed(2)}`;
                
                // Atualizar cor da barra baseado no progresso
                const progressBar = document.getElementById('recoveryProgressBar');
                if (percentageRecovered < 25) {
                    progressBar.className = 'bg-gradient-to-r from-red-600 to-red-500 h-6 rounded-full transition-all duration-500';
                } else if (percentageRecovered < 50) {
                    progressBar.className = 'bg-gradient-to-r from-red-500 to-orange-500 h-6 rounded-full transition-all duration-500';
                } else if (percentageRecovered < 75) {
                    progressBar.className = 'bg-gradient-to-r from-orange-500 to-yellow-500 h-6 rounded-full transition-all duration-500';
                } else {
                    progressBar.className = 'bg-gradient-to-r from-yellow-500 to-green-500 h-6 rounded-full transition-all duration-500';
                }
                
                if (!residualPnlChart) {
                    residualPnlChart = new Chart(document.getElementById('residualPnlChart'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: 'PnL Residual (R$)',
                                    borderColor: '#f59e0b',
                                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                    borderWidth: 2,
                                    fill: true,
                                    data: [],
                                    tension: 0.4,
                                    pointRadius: 4,
                                    pointBackgroundColor: '#f59e0b',
                                    pointHoverRadius: 6
                                },
                                {
                                    label: 'Meta (R$ 0,00)',
                                    borderColor: '#10b981',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    fill: false,
                                    data: [],
                                    tension: 0.4,
                                    pointRadius: 0
                                },
                                {
                                    label: 'Baseline (R$)',
                                    borderColor: '#fbbf24',
                                    borderWidth: 2,
                                    borderDash: [3, 3],
                                    fill: false,
                                    data: [],
                                    tension: 0.4,
                                    pointRadius: 0
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {mode: 'index', intersect: false},
                            plugins: {
                                legend: {display: true, position: 'top', labels: {color: '#9ca3af', font: {size: 11}}},
                                tooltip: {
                                    backgroundColor: 'rgba(17, 24, 39, 0.9)',
                                    titleColor: '#f3f4f6',
                                    bodyColor: '#d1d5db',
                                    borderColor: '#374151',
                                    borderWidth: 1,
                                    padding: 10,
                                    displayColors: true,
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) label += ': ';
                                            if (context.parsed.y !== null) {
                                                label += 'R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    ticks: {
                                        color: '#9ca3af',
                                        font: {size: 11},
                                        callback: function(value) {
                                            return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                        }
                                    },
                                    grid: {color: 'rgba(75, 85, 99, 0.1)'},
                                    min: Math.min(totalPnL * 1.5, -10),
                                    max: 1
                                },
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'minute',
                                        displayFormats: {minute: 'HH:mm'}
                                    },
                                    grid: {color: 'rgba(75, 85, 99, 0.1)'},
                                    ticks: {color: '#9ca3af', font: {size: 10}}
                                }
                            }
                        }
                    });
                }
                // Atualizar dados do gr√°fico de recupera√ß√£o com pontos do servidor (preferencial)
                if (residualPnlChart) {
                    let serverResidualPoints = [];
                    try {
                        // recData foi carregado acima para baseline; aproveitamos os pontos
                        if (typeof recData !== 'undefined' && recData && Array.isArray(recData.points) && recData.points.length > 0) {
                            serverResidualPoints = recData.points.map(p => ({
                                value: parseFloat(p.pnl),
                                timestamp: new Date(p.timestamp * 1000)
                            })).filter(item => !isNaN(item.value));
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Falha ao preparar pontos de recupera√ß√£o do servidor:', e?.message || e);
                    }

                    if (serverResidualPoints.length > 0) {
                        // Construir s√©ries a partir dos pontos do servidor
                        const labels = serverResidualPoints.map(item => item.timestamp);
                        const pnlSeries = serverResidualPoints.map(item => ({x: item.timestamp, y: item.value}));
                        const targetSeries = serverResidualPoints.map(item => ({x: item.timestamp, y: 0}));
                        const baselineSeries = serverResidualPoints.map(item => ({x: item.timestamp, y: recoveryBaseline}));

                        residualPnlChart.data.labels = labels;
                        residualPnlChart.data.datasets[0].data = pnlSeries;
                        residualPnlChart.data.datasets[1].data = targetSeries;
                        residualPnlChart.data.datasets[2].data = baselineSeries;
                        // Manter √∫ltimo 30
                        if (residualPnlChart.data.labels.length > 30) {
                            const excess = residualPnlChart.data.labels.length - 30;
                            residualPnlChart.data.labels.splice(0, excess);
                            residualPnlChart.data.datasets.forEach(ds => ds.data.splice(0, excess));
                        }
                        residualPnlChart.update();
                    } else if (data.stats?.pnlHistory?.length > 0) {
                        // Fallback: usar hist√≥rico de PnL existente
                        const residualData = data.stats.pnlHistory
                            .map((val, i) => ({value: parseFloat(val), timestamp: data.stats.pnlTimestamps[i]}))
                            .filter(item => !isNaN(item.value) && item.value < 0 && item.value > -1e10 && item.timestamp)
                            .slice(-30);
                        if (residualPnlChart.data.labels.length === 0 && residualData.length > 0) {
                            residualPnlChart.data.labels = residualData.map(item => new Date(item.timestamp));
                            residualPnlChart.data.datasets[0].data = residualData.map(item => ({x: new Date(item.timestamp), y: item.value}));
                            residualPnlChart.data.datasets[1].data = residualData.map(item => ({x: new Date(item.timestamp), y: 0}));
                            residualPnlChart.data.datasets[2].data = residualData.map(item => ({x: new Date(item.timestamp), y: recoveryBaseline}));
                        } else if (residualData.length > 0) {
                            const lastPoint = residualData[residualData.length - 1];
                            const ts = new Date(lastPoint.timestamp);
                            residualPnlChart.data.labels.push(ts);
                            residualPnlChart.data.datasets[0].data.push({x: ts, y: lastPoint.value});
                            residualPnlChart.data.datasets[1].data.push({x: ts, y: 0});
                            residualPnlChart.data.datasets[2].data.push({x: ts, y: recoveryBaseline});
                            if (residualPnlChart.data.labels.length > 30) {
                                residualPnlChart.data.labels.shift();
                                residualPnlChart.data.datasets[0].data.shift();
                                residualPnlChart.data.datasets[1].data.shift();
                                residualPnlChart.data.datasets[2].data.shift();
                            }
                        }
                        residualPnlChart.update();
                    }
                }
            } else {
                recoveryContainer.style.display = 'none';
            }

            document.getElementById('orderSize').textContent = data.config?.orderSize
                ? `${data.config.orderSize} BTC (~R$ ${(data.config.orderSize * (data.market?.last || 654973.00)).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })})`
                : '0.00005 BTC (~R$ 32,75)';
            document.getElementById('targetSpread').textContent = data.config?.spreadPct
                ? `${(data.config.spreadPct * 100).toFixed(2)}% ${data.config.spreadPct < 0.01 ? '‚úÖ' : data.config.spreadPct < 0.02 ? 'üòê' : '‚ö†Ô∏è'}`
                : '0.02% ‚úÖ';
            document.getElementById('cycleSec').textContent = `${data.config?.cycleSec || 15}s`;
            document.getElementById('stopLoss').textContent = data.config?.stopLoss
                ? `${(data.config.stopLoss * 100).toFixed(2)}%`
                : '0.80%';
            document.getElementById('takeProfit').textContent = data.config?.takeProfit
                ? `${(data.config.takeProfit * 100).toFixed(2)}%`
                : '2.00%';
            document.getElementById('minVolume').textContent = data.config?.minVolume
                ? `${data.config.minVolume} BTC`
                : '0.00005 BTC';
            document.getElementById('volatilityLimit').textContent = data.config?.volatilityLimit
                ? `${(data.config.volatilityLimit).toFixed(2)}%`
                : '3.50%';
            document.getElementById('rsi').textContent = data.market?.tendency?.rsi
                ? `${parseFloat(data.market.tendency.rsi).toFixed(2)} ${data.market.tendency.rsi >= 30 && data.market.tendency.rsi <= 70 ? '‚úÖ' : '‚ö†Ô∏è'}`
                : '33.22 ‚úÖ';
            document.getElementById('rsi').parentElement.className = data.market?.tendency?.rsi && (data.market.tendency.rsi >= 30 && data.market.tendency.rsi <= 70) ? 'p-1 rounded pulse-green' : 'p-1 rounded';
            document.getElementById('emaShort').textContent = data.market?.tendency?.emaShort
                ? `R$ ${parseFloat(data.market.tendency.emaShort).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`
                : 'R$ 655.200,77';
            document.getElementById('emaLong').textContent = data.market?.tendency?.emaLong
                ? `R$ ${parseFloat(data.market.tendency.emaLong).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`
                : 'R$ 655.031,24';
            document.getElementById('macd').textContent = data.market?.tendency?.macd
                ? parseFloat(data.market.tendency.macd).toFixed(2)
                : '382.09';
            document.getElementById('signal').textContent = data.market?.tendency?.signal
                ? `${parseFloat(data.market.tendency.signal).toFixed(2)} ${Math.abs(data.market.tendency.signal) > 1000 ? '‚ö†Ô∏è' : '‚úÖ'}`
                : '382.09 ‚úÖ';
            document.getElementById('signal').parentElement.className = data.market?.tendency?.signal && Math.abs(data.market.tendency.signal) > 1000 ? 'p-1 rounded pulse-orange' : 'p-1 rounded pulse-green';
            document.getElementById('expectedProfitScore').textContent = data.stats?.expectedProfitScore
                ? `${parseFloat(data.stats.expectedProfitScore).toFixed(2)} ${data.stats.expectedProfitScore >= 0.1 ? '‚úÖ' : '‚ö†Ô∏è'}`
                : '1.00 ‚úÖ';
            document.getElementById('confidence').textContent = data.market?.tendency?.confidence
                ? `${parseFloat(data.market.tendency.confidence).toFixed(2)} ${data.market.tendency.confidence >= 0.5 ? '‚úÖ' : '‚ö†Ô∏è'}`
                : '1.00 ‚úÖ';
            document.getElementById('inventoryBias').textContent = data.stats?.inventoryBias
                ? parseFloat(data.stats.inventoryBias).toFixed(6)
                : '0.000013';
            document.getElementById('trendBias').textContent = data.stats?.trendBias
                ? parseFloat(data.stats.trendBias).toFixed(6)
                : '-0.026300';
            document.getElementById('totalBias').textContent = data.stats?.totalBias
                ? parseFloat(data.stats.totalBias).toFixed(6)
                : '-0.010000';

            // Atualizar dados de tend√™ncia externa
            if (data.externalTrend) {
                if (data.externalTrend.error) {
                    document.getElementById('alignment').textContent = '‚ùå Indispon√≠vel';
                    document.getElementById('alignmentStatus').className = 'p-1 rounded pulse-orange';
                    document.getElementById('externalTrend').textContent = '--';
                    document.getElementById('externalConfidence').textContent = '--';
                    document.getElementById('externalScore').textContent = '--';
                    document.getElementById('externalSources').textContent = 'Offline';
                    document.getElementById('botVsExternal').textContent = `Bot: ${data.externalTrend.botTrend || '--'} (${parseFloat(data.externalTrend.botConfidence || 0).toFixed(2)})`;
                } else {
                    // Status de alinhamento
                    const isAligned = data.externalTrend.botAlignment === 'aligned';
                    document.getElementById('alignment').textContent = isAligned ? '‚úÖ Alinhado' : '‚ö†Ô∏è Divergente';
                    document.getElementById('alignmentStatus').className = isAligned ? 'p-1 rounded pulse-green' : 'p-1 rounded pulse-orange';
                    
                    // Tend√™ncia externa
                    const trendIcon = data.externalTrend.trend === 'up' ? 'üî•' : data.externalTrend.trend === 'down' ? '‚ùÑÔ∏è' : '‚û°Ô∏è';
                    document.getElementById('externalTrend').textContent = `${data.externalTrend.trend} ${trendIcon}`;
                    
                    // Confian√ßa externa
                    document.getElementById('externalConfidence').textContent = `${parseFloat(data.externalTrend.confidence).toFixed(2)} ${data.externalTrend.confidence >= 0.5 ? '‚úÖ' : '‚ö†Ô∏è'}`;
                    
                    // Score
                    const score = parseFloat(data.externalTrend.score);
                    const scoreIcon = score > 0.1 ? 'üìà' : score < -0.1 ? 'üìâ' : '‚û°Ô∏è';
                    document.getElementById('externalScore').textContent = `${score.toFixed(2)} ${scoreIcon}`;
                    
                    // Status das fontes
                    const sources = data.externalTrend.sources;
                    const sourcesStatus = [];
                    if (sources.coinGecko) sourcesStatus.push('CG‚úÖ');
                    if (sources.binance) sourcesStatus.push('BIN‚úÖ');
                    if (sources.fearGreed) sourcesStatus.push('FG‚úÖ');
                    document.getElementById('externalSources').textContent = sourcesStatus.length > 0 ? sourcesStatus.join(' ') : 'Nenhuma ativa';
                    
                    // Compara√ß√£o Bot vs Externo
                    if (data.externalTrend.details) {
                        const botTrendIcon = data.externalTrend.details.botTrend === 'up' ? 'üî•' : data.externalTrend.details.botTrend === 'down' ? '‚ùÑÔ∏è' : '‚û°Ô∏è';
                        const extTrendIcon = data.externalTrend.details.externalTrend === 'up' ? 'üî•' : data.externalTrend.details.externalTrend === 'down' ? '‚ùÑÔ∏è' : '‚û°Ô∏è';
                        document.getElementById('botVsExternal').textContent = `${botTrendIcon} ${parseFloat(data.externalTrend.details.botConfidence).toFixed(2)} vs ${extTrendIcon} ${parseFloat(data.externalTrend.details.externalConfidence).toFixed(2)}`;
                    }
                }
            } else {
                document.getElementById('alignment').textContent = '‚ùì Sem dados';
                document.getElementById('alignmentStatus').className = 'p-1 rounded';
                document.getElementById('externalTrend').textContent = '--';
                document.getElementById('externalConfidence').textContent = '--';
                document.getElementById('externalScore').textContent = '--';
                document.getElementById('externalSources').textContent = '--';
                document.getElementById('botVsExternal').textContent = '--';
            }

            document.getElementById('unrealizedPnl').textContent = data.stats?.unrealizedPnl
                ? `R$ ${parseFloat(data.stats.unrealizedPnl).toFixed(2)} ${data.stats.unrealizedPnl > 0 ? 'üìà' : data.stats.unrealizedPnl < 0 ? 'üìâ' : 'üòê'}`
                : 'R$ 0.00 üìà';
            document.getElementById('unrealizedPnl').parentElement.className = data.stats?.unrealizedPnl && data.stats.unrealizedPnl < 0 ? 'p-1 rounded pulse-orange' : 'p-1 rounded pulse-green';
            document.getElementById('btcPosition').textContent = data.stats?.btcPosition
                ? `${parseFloat(data.stats.btcPosition).toFixed(8)} BTC`
                : '0.00002000 BTC';
            document.getElementById('fillRate').textContent = data.stats?.fillRate
                ? `${data.stats.fillRate} ${data.stats.fillRate.replace('%', '') >= 20 ? '‚úÖ' : '‚ö†Ô∏è'}`
                : '24.0% ‚úÖ';
            document.getElementById('avgFillPrice').textContent = data.stats?.avgFillPrice
                ? `R$ ${parseFloat(data.stats.avgFillPrice).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`
                : 'R$ 654.259,13';
            document.getElementById('uptime').textContent = data.stats?.uptime
                ? `${data.stats.uptime}`
                : '23 minutos';
            document.getElementById('roi').textContent = data.stats?.roi
                ? `${parseFloat(data.stats.roi).toFixed(2)}% ${data.stats.roi > 0 ? 'üìà' : data.stats.roi < 0 ? 'üìâ' : 'üòê'}`
                : '0.01% üìà';
            
            const regimeEl = document.getElementById('regime');
            if (data.stats?.regime) {
                regimeEl.textContent = data.stats.regime;
                regimeEl.className = data.stats.regime.includes('BULL') ? 'text-green-400 font-bold' : 
                                   data.stats.regime.includes('BEAR') ? 'text-red-400 font-bold' : 'text-gray-400 font-bold';
            }
            document.getElementById('roi').parentElement.className = data.stats?.roi && data.stats.roi < 0 ? 'p-1 rounded pulse-orange' : 'p-1 rounded pulse-green';

            const trendEl = document.getElementById('trend');
            const priceToUse = data.config?.simulate ? parseFloat(data.market?.tendency?.midPrice || 654973.00) : parseFloat(data.market?.last || 654973.00);
            if (data.market?.tendency?.trend === 'up') {
                trendEl.textContent = `Alta üìà - R$ ${priceToUse.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
                trendEl.className = "text-green-400 font-bold";
                trendEl.parentElement.className = 'p-1 rounded pulse-green';
            } else if (data.market?.tendency?.trend === 'down') {
                trendEl.textContent = `Baixa üìâ - R$ ${priceToUse.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
                trendEl.className = "text-red-400 font-bold";
                trendEl.parentElement.className = 'p-1 rounded pulse-orange';
            } else {
                trendEl.textContent = `Neutra ‚û°Ô∏è - R$ ${priceToUse.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
                trendEl.className = "text-gray-400 font-bold";
                trendEl.parentElement.className = 'p-1 rounded';
            }

            // ===== CARREGAR PARES BUY/SELL =====
            try {
                const pairsRes = await fetch(`/api/pairs?t=${Date.now()}`);
                const pairsData = await pairsRes.json();
                
                if (pairsData && pairsData.pairs && Array.isArray(pairsData.pairs)) {
                    // Atualizar contadores
                    document.getElementById('totalPairsCount').textContent = pairsData.totalPairs || 0;
                    document.getElementById('completePairsCount').textContent = pairsData.completePairs || 0;
                    document.getElementById('incompletePairsCount').textContent = pairsData.incompletePairs || 0;
                    
                    // Calcular ROI m√©dio apenas para pares completos
                    const completePairs = pairsData.pairs.filter(p => p.status === 'COMPLETO');
                    let avgRoi = 0;
                    if (completePairs.length > 0) {
                        const totalRoi = completePairs.reduce((sum, p) => {
                            const roiStr = p.roi || '0.000%';
                            const roiVal = parseFloat(roiStr.replace('%', ''));
                            return sum + roiVal;
                        }, 0);
                        avgRoi = totalRoi / completePairs.length;
                    }
                    document.getElementById('avgPairRoi').textContent = avgRoi.toFixed(3) + '%';
                    
                    // Atualizar tabela de pares
                    const tbody = document.getElementById('pairsTableBody');
                    tbody.innerHTML = '';
                    
                    if (pairsData.pairs.length === 0) {
                        tbody.innerHTML = '<tr><td class="p-2 text-gray-400 text-center" colspan="6">Nenhum par registrado</td></tr>';
                    } else {
                        pairsData.pairs.forEach(pair => {
                            const tr = document.createElement('tr');
                            tr.className = 'border-b border-gray-700 hover:bg-gray-700 transition';
                            
                            // Determinar cores baseado em status
                            let statusColor = 'text-yellow-400';
                            let statusIcon = '‚è≥';
                            if (pair.status === 'COMPLETO') {
                                statusColor = 'text-green-400';
                                statusIcon = '‚úÖ';
                            } else if (pair.status === 'AGUARDANDO_BUY') {
                                statusColor = 'text-orange-400';
                                statusIcon = 'üî¥';
                            } else if (pair.status === 'AGUARDANDO_SELL') {
                                statusColor = 'text-blue-400';
                                statusIcon = 'üü¢';
                            }
                            
                            const spreadVal = pair.spread || '0.000%';
                            const roiVal = pair.roi || '0.000%';
                            const spreadNum = parseFloat(spreadVal.replace('%', ''));
                            const roiNum = parseFloat(roiVal.replace('%', ''));
                            
                            tr.innerHTML = `
                                <td class="p-2 text-gray-300 font-mono text-xs truncate" title="${pair.pairId}">
                                    ${pair.pairId}
                                </td>
                                <td class="p-2">
                                    <span class="${statusColor} font-semibold">${statusIcon} ${pair.status}</span>
                                </td>
                                <td class="p-2 text-center">
                                    ${pair.buyOrder ? `üü¢ R$ ${pair.buyOrder.price}` : '‚ùå'}
                                </td>
                                <td class="p-2 text-center">
                                    ${pair.sellOrder ? `üî¥ R$ ${pair.sellOrder.price}` : '‚ùå'}
                                </td>
                                <td class="p-2 text-right ${spreadNum >= 0 ? 'text-green-400' : 'text-red-400'} font-semibold">
                                    ${spreadVal}
                                </td>
                                <td class="p-2 text-right ${roiNum >= 0 ? 'text-green-400' : 'text-red-400'} font-semibold">
                                    ${roiVal}
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                    
                    // Atualizar badge de refresh
                    document.getElementById('pairsRefreshBadge').textContent = `Atualizado ${new Date().toLocaleTimeString('pt-BR')}`;
                    document.getElementById('pairsRefreshBadge').className = 'text-xs px-2 py-1 bg-green-700 rounded text-green-200';
                }
            } catch (pairsError) {
                console.error('‚ùå Erro ao carregar pares:', pairsError);
                document.getElementById('pairsRefreshBadge').textContent = 'Erro ao carregar pares';
                document.getElementById('pairsRefreshBadge').className = 'text-xs px-2 py-1 bg-red-700 rounded text-red-200';
            }

        } catch (error) {
            console.error('‚ùå Error loading data:', error);
            document.getElementById('pnl').textContent = 'Erro ao carregar';
            document.getElementById('spread').textContent = 'Erro';
            document.getElementById('lastPrice').textContent = 'Erro';
        }
    }

    // ===== EVENT LISTENER PARA BOT√ÉO DE RESET =====
    document.addEventListener('DOMContentLoaded', () => {
        const resetBtn = document.getElementById('resetBaselineBtn');
        if (resetBtn) {
            resetBtn.addEventListener('click', async () => {
                if (!confirm('‚ö†Ô∏è Confirma atualiza√ß√£o do baseline da sess√£o ativa para o PnL atual?\n\nIsso N√ÉO encerrar√° a sess√£o; apenas atualiza o baseline para o valor do PnL no momento.')) {
                    return;
                }
                
                try {
                    resetBtn.disabled = true;
                    resetBtn.textContent = 'Atualizando...';
                    
                    const response = await fetch('/api/recovery/reset', {method: 'POST'});
                    const result = await response.json();
                    
                    if (response.ok) {
                        localStorage.removeItem('lastRecoverySessionId');
                        console.log('‚úÖ Baseline atualizado com sucesso:', result.message, 'novo baseline:', result.baseline);
                        
                        const badge = document.getElementById('baselineBadge');
                        if (badge) {
                            badge.textContent = `Baseline: R$ ${parseFloat(result.baseline).toFixed(2)}`;
                            badge.classList.remove('hidden');
                            setTimeout(() => badge.classList.add('hidden'), 6000);
                        }
                        
                        // Recarregar dados ap√≥s 1 segundo para refletir baseline atual
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        alert('‚ùå Erro ao atualizar baseline: ' + (result.error || 'Erro desconhecido'));
                    }
                } catch (err) {
                    console.error('Erro ao atualizar baseline:', err);
                    alert('‚ùå Erro de conex√£o ao tentar atualizar baseline');
                } finally {
                    resetBtn.disabled = false;
                    resetBtn.textContent = '‚Üª Atualizar baseline';
                }
            });
        }
    });

    // Exibir badge se houve reset na √∫ltima atualiza√ß√£o
    function checkResetBadge() {
        const flag = localStorage.getItem('baselineResetJustNow');
        if (flag === '1') {
            const badge = document.getElementById('baselineBadge');
            if (badge) {
                badge.textContent = 'Baseline resetado';
                badge.classList.remove('hidden');
                setTimeout(() => badge.classList.add('hidden'), 3000);
            }
            localStorage.removeItem('baselineResetJustNow');
        }
    }

    // Iniciar atualiza√ß√£o autom√°tica apenas ap√≥s DOM estar pronto
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
                checkResetBadge();
            loadData();
            setInterval(loadData, 5 * 1000);
        });
    } else {
            checkResetBadge();
        loadData();
        setInterval(loadData, 5 * 1000);
    }
</script>
</body>
</html>