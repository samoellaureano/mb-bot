<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MB Bot Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        @keyframes pulse-green {
            0% {
                background-color: rgba(74, 222, 128, 0.1);
            }
            50% {
                background-color: rgba(74, 222, 128, 0.3);
            }
            100% {
                background-color: rgba(74, 222, 128, 0.1);
            }
        }

        @keyframes pulse-orange {
            0% {
                background-color: rgba(251, 146, 60, 0.1);
            }
            50% {
                background-color: rgba(251, 146, 60, 0.3);
            }
            100% {
                background-color: rgba(251, 146, 60, 0.1);
            }
        }

        .pulse-green {
            animation: pulse-green 2s infinite;
        }

        .pulse-orange {
            animation: pulse-orange 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">
<div class="container mx-auto p-4">
    <div class="flex justify-between items-center mb-4">
        <h1 class="text-xl sm:text-2xl font-bold">üìä MB Bot Dashboard</h1>
        <span id="mode" class="px-2 py-1 sm:px-3 sm:py-1 bg-green-600 rounded-full text-xs sm:text-sm">Modo: Live</span>
    </div>
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow border-l-4 border-blue-500">
            <p class="text-gray-400 text-xs sm:text-sm">√öltimo Pre√ßo</p>
            <h2 id="lastPrice" class="text-lg sm:text-xl font-bold">Carregando...</h2>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow border-l-4 border-yellow-500">
            <p class="text-gray-400 text-xs sm:text-sm">Spread / Volatilidade</p>
            <h2 id="spread" class="text-lg sm:text-xl font-bold">--</h2>
            <p id="volatility" class="text-xs sm:text-sm text-gray-400">Vol: --</p>
        </div>
        <div id="pnlCard" class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow border-l-4 border-gray-500">
            <p class="text-gray-400 text-xs sm:text-sm">Lucro Total (PnL)</p>
            <h2 id="pnl" class="text-lg sm:text-xl font-bold">R$ 0,00</h2>
            <p id="roi" class="text-xs sm:text-sm text-gray-400">ROI: 0,00%</p>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow border-l-4 border-purple-500">
            <p class="text-gray-400 text-xs sm:text-sm">Saldo Total Est.</p>
            <h2 id="totalBalanceCard" class="text-lg sm:text-xl font-bold">Carregando...</h2>
            <p id="monthlyPnl" class="text-xs sm:text-sm text-gray-400">Mensal: R$ 0,00</p>
        </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-2">Ordens Ativas</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-xs sm:text-sm">
                    <thead>
                    <tr class="text-gray-400">
                        <th class="text-left p-1 sm:p-2">Side</th>
                        <th class="text-left p-1 sm:p-2">ID</th>
                        <th class="text-left p-1 sm:p-2">Pre√ßo</th>
                        <th class="text-left p-1 sm:p-2">Qtd</th>
                        <th class="text-left p-1 sm:p-2">Status</th>
                        <th class="text-left p-1 sm:p-2">Drift</th>
                        <th class="text-left p-1 sm:p-2">Age</th>
                    </tr>
                    </thead>
                    <tbody id="ordersTable">
                    <tr>
                        <td class="text-red-400 p-1 sm:p-2">sell</td>
                        <td class="p-1 sm:p-2">01K70C1BRYAXM0PD92BRESXN7A</td>
                        <td class="p-1 sm:p-2">R$ 655.532,00</td>
                        <td class="p-1 sm:p-2">0.000020</td>
                        <td class="p-1 sm:p-2">working</td>
                        <td class="p-1 sm:p-2">0.05%</td>
                        <td class="p-1 sm:p-2">00:04:19</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-2">Saldos</h2>
            <ul class="space-y-1 text-xs sm:text-sm">
                <li>BRL: <span id="brl">Carregando...</span></li>
                <li>BTC: <span id="btc">Carregando...</span></li>
                <li>Total: <span id="totalBalanceList">Carregando...</span></li>
            </ul>
        </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-2">Evolu√ß√£o do PnL</h2>
            <div class="w-full h-64 sm:h-72">
                <canvas id="pnlChart"></canvas>
            </div>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow" id="recoveryMonitorContainer" style="display:none;">
            <h2 class="text-base sm:text-lg font-bold mb-4" style="color: #fbbf24;">Monitor de Recupera√ß√£o (PnL Residual)</h2>
            <div class="w-full h-64 sm:h-72">
                <canvas id="residualPnlChart"></canvas>
            </div>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-4">Config & Tend√™ncia</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <h3 class="text-sm font-semibold mb-2 text-gray-300">Configura√ß√µes do Bot</h3>
                    <ul class="space-y-1 text-xs sm:text-sm">
                        <li title="Tamanho m√≠nimo de cada ordem em BTC" class="p-1 rounded pulse-green">
                            Ordem size: <span id="orderSize">0.00005 BTC (~R$ 32,75)</span>
                        </li>
                        <li title="Percentual alvo de diferen√ßa entre compra e venda" class="p-1 rounded pulse-green">
                            Spread alvo: <span id="targetSpread">0.02% ‚úÖ</span>
                        </li>
                        <li title="Intervalo entre ciclos de decis√£o do bot" class="p-1 rounded">
                            Intervalo ciclo: <span id="cycleSec">15s</span>
                        </li>
                        <li title="Limite de perda para cancelar ordens" class="p-1 rounded">
                            Stop-Loss: <span id="stopLoss">0.80%</span>
                        </li>
                        <li title="Meta de lucro para realizar ganhos" class="p-1 rounded">
                            Take-Profit: <span id="takeProfit">2.00%</span>
                        </li>
                        <li title="Volume m√≠nimo para ordens serem v√°lidas" class="p-1 rounded">
                            Volume M√≠nimo: <span id="minVolume">0.00005 BTC</span>
                        </li>
                        <li title="Limite m√°ximo de volatilidade para operar" class="p-1 rounded">
                            Limite de Volatilidade: <span id="volatilityLimit">3.50%</span>
                        </li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold mb-2 text-gray-300">Indicadores T√©cnicos</h3>
                    <ul class="space-y-1 text-xs sm:text-sm">
                        <li title="Tend√™ncia do mercado com base em indicadores" class="p-1 rounded">
                                    Tend√™ncia: <span id="trend">Neutra ‚û°Ô∏è - R$ 654.973,00</span>
                        </li>
                        <li title="Regime de mercado atual" class="p-1 rounded">
                            Regime: <span id="regime" class="font-bold">NEUTRAL</span>
                        </li>     </li>
                        <li title="√çndice de For√ßa Relativa (0-100, <30 sobrevendido, >70 sobrecomprado)"
                            class="p-1 rounded">
                            RSI: <span id="rsi">33.22 ‚úÖ</span>
                        </li>
                        <li title="M√©dia M√≥vel Exponencial de curto prazo (8 per√≠odos)" class="p-1 rounded">
                            EMA Curta: <span id="emaShort">R$ 655.200,77</span>
                        </li>
                        <li title="M√©dia M√≥vel Exponencial de longo prazo (20 per√≠odos)" class="p-1 rounded">
                            EMA Longa: <span id="emaLong">R$ 655.031,24</span>
                        </li>
                        <li title="Diferen√ßa entre EMAs de 12 e 26 per√≠odos" class="p-1 rounded">
                            MACD: <span id="macd">382.09</span>
                        </li>
                        <li title="M√©dia M√≥vel do MACD (9 per√≠odos)" class="p-1 rounded pulse-green">
                            Signal: <span id="signal">382.09 ‚úÖ</span>
                        </li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold mb-2 text-gray-300">Vi√©s e Performance</h3>
                    <ul class="space-y-1 text-xs sm:text-sm">
                        <li title="Probabilidade de lucro estimada (0 a 1)" class="p-1 rounded pulse-green">
                            Score Lucro Esperado: <span id="expectedProfitScore">1.00 ‚úÖ</span>
                        </li>
                        <li title="Confian√ßa na previs√£o de tend√™ncia (0 a 1)" class="p-1 rounded pulse-green">
                            Confian√ßa: <span id="confidence">1.00 ‚úÖ</span>
                        </li>
                        <li title="Ajuste de pre√ßo com base no saldo de BTC" class="p-1 rounded">
                            Vi√©s Invent√°rio: <span id="inventoryBias">0.000013</span>
                        </li>
                        <li title="Ajuste de pre√ßo com base na tend√™ncia do mercado" class="p-1 rounded">
                            Vi√©s Tend√™ncia: <span id="trendBias">-0.026300</span>
                        </li>
                        <li title="Combina√ß√£o de vi√©s de invent√°rio e tend√™ncia" class="p-1 rounded">
                            Total Bias: <span id="totalBias">-0.010000</span>
                        </li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold mb-2 text-gray-300">Posi√ß√£o e Resultados</h3>
                    <ul class="space-y-1 text-xs sm:text-sm">
                        <li title="Lucro/preju√≠zo n√£o realizado da posi√ß√£o atual" class="p-1 rounded pulse-green">
                            PnL N√£o Realizado: <span id="unrealizedPnl">R$ 0.00 üìà</span>
                        </li>
                        <li title="Quantidade de BTC em posi√ß√£o" class="p-1 rounded">
                            Posi√ß√£o BTC: <span id="btcPosition">0.00002000 BTC</span>
                        </li>
                        <li title="Percentual de ordens executadas com sucesso" class="p-1 rounded pulse-green">
                            Taxa de Fill: <span id="fillRate">24.0% ‚úÖ</span>
                        </li>
                        <li title="Pre√ßo m√©dio das ordens executadas" class="p-1 rounded">
                            Pre√ßo M√©dio Fill: <span id="avgFillPrice">R$ 654.259,13</span>
                        </li>
                        <li title="Tempo de atividade do bot" class="p-1 rounded pulse-green">
                            Uptime: <span id="uptime">23 minutos</span>
                        </li>
                        <li title="Retorno sobre investimento (ROI)" class="p-1 rounded pulse-green">
                            ROI: <span id="roi">0.01% üìà</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const priceHistory = [];
    let pnlChart;
    let residualPnlChart;

    document.addEventListener('DOMContentLoaded', () => {
        pnlChart = new Chart(document.getElementById('pnlChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: "PnL (R$)",
                        borderColor: "#10b981",
                        backgroundColor: "rgba(16,185,129,0.1)",
                        borderWidth: 2,
                        fill: true,
                        data: [],
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        yAxisID: 'y'
                    },
                    {
                        label: "BTC Price (R$)",
                        borderColor: "#3b82f6",
                        backgroundColor: "transparent",
                        borderWidth: 1.5,
                        borderDash: [5, 5],
                        fill: false,
                        data: [],
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {mode: 'index', intersect: false},
                plugins: {
                    legend: {display: true, position: 'top', labels: {color: '#9ca3af', font: {size: 11}}},
                    tooltip: {
                        backgroundColor: 'rgba(17, 24, 39, 0.9)',
                        titleColor: '#f3f4f6',
                        bodyColor: '#d1d5db',
                        borderColor: '#374151',
                        borderWidth: 1,
                        padding: 10,
                        displayColors: true
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: {display: true, text: 'PnL (R$)', color: '#10b981'},
                        grid: {color: 'rgba(75, 85, 99, 0.1)'},
                        ticks: {color: '#9ca3af', font: {size: 10}}
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        title: {display: true, text: 'BTC Price (R$)', color: '#3b82f6'},
                        grid: {drawOnChartArea: false},
                        ticks: {color: '#9ca3af', font: {size: 10}}
                    },
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            displayFormats: {minute: 'HH:mm'}
                        },
                        grid: {color: 'rgba(75, 85, 99, 0.1)'},
                        ticks: {color: '#9ca3af', font: {size: 10}}
                    }
                }
            }
        });
    });

    function formatSpread(spread) {
        if (!spread && spread !== 0) return "Sem dados";
        const value = Number(spread).toFixed(2);
        let level = "";
        if (spread < 0.5) level = " (muito baixo) ‚úÖ";
        else if (spread < 1.5) level = " (moderado) üòê";
        else level = " (alto) ‚ö†Ô∏è";
        return `${value}%${level}`;
    }

    function formatVolatility(vol) {
        if (!vol && vol !== 0) return "Sem dados";
        const value = Number(vol).toFixed(2);
        let desc = "";
        if (vol < 0.5) desc = " (est√°vel) ‚úÖ";
        else if (vol < 1.5) desc = " (moderada) üòê";
        else desc = " (alta) ‚ö†Ô∏è";
        return `${value}%${desc}`;
    }

    async function loadData() {
        try {
            const res = await fetch(`/api/data?t=${Date.now()}`);
            const data = await res.json();

            const modeSpan = document.getElementById('mode');
            modeSpan.textContent = `Modo: ${data.config?.simulate ? 'Simula√ß√£o' : 'Live'}`;
            modeSpan.className = data.config?.simulate
                ? 'px-2 py-1 sm:px-3 sm:py-1 bg-yellow-600 rounded-full text-xs sm:text-sm'
                : 'px-2 py-1 sm:px-3 sm:py-1 bg-green-600 rounded-full text-xs sm:text-sm';

            const lastPrice = parseFloat(data.market?.last) || 654973.00;
            document.getElementById('lastPrice').textContent = `R$ ${lastPrice.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;

            document.getElementById('spread').textContent = formatSpread(data.market?.spread || 0.06);
            document.getElementById('volatility').textContent = formatVolatility(data.market?.volatility || 0.26);

            const totalPnL = parseFloat(data.stats?.totalPnL || 0);
            const pnlEl = document.getElementById('pnl');
            const pnlCard = document.getElementById('pnlCard');
            
            pnlEl.textContent = `R$ ${totalPnL.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })} ${totalPnL > 0 ? 'üìà' : totalPnL < 0 ? 'üìâ' : 'üòê'}`;
            
            if (totalPnL > 0) {
                pnlEl.className = "text-green-400 text-lg sm:text-xl font-bold";
                pnlCard.className = "bg-gray-800 p-2 sm:p-4 rounded-xl shadow border-l-4 border-green-500";
            } else if (totalPnL < 0) {
                pnlEl.className = "text-red-400 text-lg sm:text-xl font-bold";
                pnlCard.className = "bg-gray-800 p-2 sm:p-4 rounded-xl shadow border-l-4 border-red-500";
            } else {
                pnlEl.className = "text-gray-400 text-lg sm:text-xl font-bold";
                pnlCard.className = "bg-gray-800 p-2 sm:p-4 rounded-xl shadow border-l-4 border-gray-500";
            }

            document.getElementById('monthlyPnl').textContent = `Mensal: R$ ${parseFloat(data.stats?.monthlyPnL || 0).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;

            document.getElementById('brl').textContent = `R$ ${parseFloat(data.balances?.brl || 0).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
            document.getElementById('btc').textContent = `${parseFloat(data.balances?.btc || 0).toFixed(8)} BTC`;
            const totalFormatted = `R$ ${parseFloat(data.balances?.total || 0).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
            document.getElementById('totalBalanceCard').textContent = totalFormatted;
            document.getElementById('totalBalanceList').textContent = totalFormatted;

            const tbody = document.getElementById('ordersTable');
            tbody.innerHTML = '';
            (data.activeOrders || []).forEach(order => {
                const age = order.ageSecMinHour || {ageHour: 0, ageMin: 0, ageSec: 0};
                const ageStr = `${String(age.ageHour).padStart(2, '0')}:${String(age.ageMin % 60).padStart(2, '0')}:${String(age.ageSec % 60).padStart(2, '0')}`;
                const priceFormatted = parseFloat(order.price || 0).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="${order.side === 'buy' ? 'text-green-400' : 'text-red-400'} p-1 sm:p-2">${order.side || '--'}</td>
                    <td class="p-1 sm:p-2">${order.id || '--'}</td>
                    <td class="p-1 sm:p-2">R$ ${priceFormatted}</td>
                    <td class="p-1 sm:p-2">${parseFloat(order.qty || '0').toFixed(6)}</td>
                    <td class="p-1 sm:p-2">${order.status || '--'}</td>
                    <td class="p-1 sm:p-2">${order.drift || '--'}</td>
                    <td class="p-1 sm:p-2">${ageStr}</td>
                `;
                tbody.appendChild(tr);
            });

            if (pnlChart && data.stats?.pnlHistory?.length > 0 && data.stats?.pnlTimestamps?.length > 0) {
                const priceToUse = data.config?.simulate ? parseFloat(data.market?.tendency?.midPrice || '654973.00') : parseFloat(data.market?.last || 654973.00);
                const validPnLData = data.stats.pnlHistory
                    .map((val, i) => ({value: parseFloat(val), timestamp: data.stats.pnlTimestamps[i]}))
                    .filter(item => !isNaN(item.value) && item.value < 1e10 && item.timestamp);
                if (pnlChart.data.labels.length === 0) {
                    pnlChart.data.labels = validPnLData.map(item => new Date(item.timestamp));
                    pnlChart.data.datasets[0].data = validPnLData.map(item => ({
                        x: new Date(item.timestamp),
                        y: item.value
                    }));
                    pnlChart.data.datasets[1].data = validPnLData.map(item => ({
                        x: new Date(item.timestamp),
                        y: priceToUse
                    }));
                } else {
                    const lastTimestamp = pnlChart.data.labels[pnlChart.data.labels.length - 1];
                    const newTimestamp = new Date(data.timestamp);
                    if (!lastTimestamp || (newTimestamp - lastTimestamp) >= 60000) {
                        const lastValidPnL = validPnLData.length > 0 ? validPnLData[validPnLData.length - 1].value : parseFloat(data.stats.totalPnL || '0.06');
                        pnlChart.data.labels.push(newTimestamp);
                        pnlChart.data.datasets[0].data.push({
                            x: newTimestamp,
                            y: lastValidPnL
                        });
                        pnlChart.data.datasets[1].data.push({x: newTimestamp, y: priceToUse});
                        pnlChart.data.datasets[2].data.push({x: newTimestamp, y: 42.56});
                    }
                }
                if (pnlChart.data.labels.length > 40) {
                    pnlChart.data.labels.shift();
                    pnlChart.data.datasets[0].data.shift();
                    pnlChart.data.datasets[1].data.shift();
                }
                pnlChart.update();
            }

            // Monitor de Recupera√ß√£o
            const isRecovering = data.config?.isRecovering || false;
            const recoveryContainer = document.getElementById('recoveryMonitorContainer');
            if (isRecovering && totalPnL < 0) {
                recoveryContainer.style.display = 'block';
                if (!residualPnlChart) {
                    residualPnlChart = new Chart(document.getElementById('residualPnlChart'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: 'PnL Residual (R$)',
                                    borderColor: '#f59e0b',
                                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                    borderWidth: 2,
                                    fill: true,
                                    data: [],
                                    tension: 0.4,
                                    pointRadius: 4,
                                    pointBackgroundColor: '#f59e0b',
                                    pointHoverRadius: 6
                                },
                                {
                                    label: 'Meta (R$ 0,00)',
                                    borderColor: '#10b981',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    fill: false,
                                    data: [],
                                    tension: 0.4,
                                    pointRadius: 0
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {mode: 'index', intersect: false},
                            plugins: {
                                legend: {display: true, position: 'top', labels: {color: '#9ca3af', font: {size: 11}}},
                                tooltip: {
                                    backgroundColor: 'rgba(17, 24, 39, 0.9)',
                                    titleColor: '#f3f4f6',
                                    bodyColor: '#d1d5db',
                                    borderColor: '#374151',
                                    borderWidth: 1,
                                    padding: 10,
                                    displayColors: true,
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) label += ': ';
                                            if (context.parsed.y !== null) {
                                                label += 'R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 4, maximumFractionDigits: 4});
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    ticks: {
                                        color: '#9ca3af',
                                        font: {size: 10},
                                        callback: function(value) {
                                            return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 4, maximumFractionDigits: 4});
                                        }
                                    },
                                    grid: {color: 'rgba(75, 85, 99, 0.1)'},
                                    min: totalPnL * 1.2,
                                    max: 0
                                },
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'minute',
                                        displayFormats: {minute: 'HH:mm'}
                                    },
                                    grid: {color: 'rgba(75, 85, 99, 0.1)'},
                                    ticks: {color: '#9ca3af', font: {size: 10}}
                                }
                            }
                        }
                    });
                }
                // Atualizar dados do gr√°fico de recupera√ß√£o
                if (residualPnlChart && data.stats?.pnlHistory?.length > 0) {
                    const residualData = data.stats.pnlHistory
                        .map((val, i) => ({value: parseFloat(val), timestamp: data.stats.pnlTimestamps[i]}))
                        .filter(item => !isNaN(item.value) && item.value < 0 && item.value > -1e10 && item.timestamp)
                        .slice(-30);
                    if (residualPnlChart.data.labels.length === 0 && residualData.length > 0) {
                        residualPnlChart.data.labels = residualData.map(item => new Date(item.timestamp));
                        residualPnlChart.data.datasets[0].data = residualData.map(item => ({x: new Date(item.timestamp), y: item.value}));
                        residualPnlChart.data.datasets[1].data = residualData.map(item => ({x: new Date(item.timestamp), y: 0}));
                    } else if (residualData.length > 0) {
                        const lastPoint = residualData[residualData.length - 1];
                        residualPnlChart.data.labels.push(new Date(lastPoint.timestamp));
                        residualPnlChart.data.datasets[0].data.push({x: new Date(lastPoint.timestamp), y: lastPoint.value});
                        residualPnlChart.data.datasets[1].data.push({x: new Date(lastPoint.timestamp), y: 0});
                        if (residualPnlChart.data.labels.length > 30) {
                            residualPnlChart.data.labels.shift();
                            residualPnlChart.data.datasets[0].data.shift();
                            residualPnlChart.data.datasets[1].data.shift();
                        }
                    }
                    residualPnlChart.update();
                }
            } else {
                recoveryContainer.style.display = 'none';
            }

            document.getElementById('orderSize').textContent = data.config?.orderSize
                ? `${data.config.orderSize} BTC (~R$ ${(data.config.orderSize * (data.market?.last || 654973.00)).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })})`
                : '0.00005 BTC (~R$ 32,75)';
            document.getElementById('targetSpread').textContent = data.config?.spreadPct
                ? `${(data.config.spreadPct * 100).toFixed(2)}% ${data.config.spreadPct < 0.01 ? '‚úÖ' : data.config.spreadPct < 0.02 ? 'üòê' : '‚ö†Ô∏è'}`
                : '0.02% ‚úÖ';
            document.getElementById('cycleSec').textContent = `${data.config?.cycleSec || 15}s`;
            document.getElementById('stopLoss').textContent = data.config?.stopLoss
                ? `${(data.config.stopLoss * 100).toFixed(2)}%`
                : '0.80%';
            document.getElementById('takeProfit').textContent = data.config?.takeProfit
                ? `${(data.config.takeProfit * 100).toFixed(2)}%`
                : '2.00%';
            document.getElementById('minVolume').textContent = data.config?.minVolume
                ? `${data.config.minVolume} BTC`
                : '0.00005 BTC';
            document.getElementById('volatilityLimit').textContent = data.config?.volatilityLimit
                ? `${(data.config.volatilityLimit).toFixed(2)}%`
                : '3.50%';
            document.getElementById('rsi').textContent = data.market?.tendency?.rsi
                ? `${parseFloat(data.market.tendency.rsi).toFixed(2)} ${data.market.tendency.rsi >= 30 && data.market.tendency.rsi <= 70 ? '‚úÖ' : '‚ö†Ô∏è'}`
                : '33.22 ‚úÖ';
            document.getElementById('rsi').parentElement.className = data.market?.tendency?.rsi && (data.market.tendency.rsi >= 30 && data.market.tendency.rsi <= 70) ? 'p-1 rounded pulse-green' : 'p-1 rounded';
            document.getElementById('emaShort').textContent = data.market?.tendency?.emaShort
                ? `R$ ${parseFloat(data.market.tendency.emaShort).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`
                : 'R$ 655.200,77';
            document.getElementById('emaLong').textContent = data.market?.tendency?.emaLong
                ? `R$ ${parseFloat(data.market.tendency.emaLong).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`
                : 'R$ 655.031,24';
            document.getElementById('macd').textContent = data.market?.tendency?.macd
                ? parseFloat(data.market.tendency.macd).toFixed(2)
                : '382.09';
            document.getElementById('signal').textContent = data.market?.tendency?.signal
                ? `${parseFloat(data.market.tendency.signal).toFixed(2)} ${Math.abs(data.market.tendency.signal) > 1000 ? '‚ö†Ô∏è' : '‚úÖ'}`
                : '382.09 ‚úÖ';
            document.getElementById('signal').parentElement.className = data.market?.tendency?.signal && Math.abs(data.market.tendency.signal) > 1000 ? 'p-1 rounded pulse-orange' : 'p-1 rounded pulse-green';
            document.getElementById('expectedProfitScore').textContent = data.stats?.expectedProfitScore
                ? `${parseFloat(data.stats.expectedProfitScore).toFixed(2)} ${data.stats.expectedProfitScore >= 0.1 ? '‚úÖ' : '‚ö†Ô∏è'}`
                : '1.00 ‚úÖ';
            document.getElementById('confidence').textContent = data.market?.tendency?.confidence
                ? `${parseFloat(data.market.tendency.confidence).toFixed(2)} ${data.market.tendency.confidence >= 0.5 ? '‚úÖ' : '‚ö†Ô∏è'}`
                : '1.00 ‚úÖ';
            document.getElementById('inventoryBias').textContent = data.stats?.inventoryBias
                ? parseFloat(data.stats.inventoryBias).toFixed(6)
                : '0.000013';
            document.getElementById('trendBias').textContent = data.stats?.trendBias
                ? parseFloat(data.stats.trendBias).toFixed(6)
                : '-0.026300';
            document.getElementById('totalBias').textContent = data.stats?.totalBias
                ? parseFloat(data.stats.totalBias).toFixed(6)
                : '-0.010000';
            document.getElementById('unrealizedPnl').textContent = data.stats?.unrealizedPnl
                ? `R$ ${parseFloat(data.stats.unrealizedPnl).toFixed(2)} ${data.stats.unrealizedPnl > 0 ? 'üìà' : data.stats.unrealizedPnl < 0 ? 'üìâ' : 'üòê'}`
                : 'R$ 0.00 üìà';
            document.getElementById('unrealizedPnl').parentElement.className = data.stats?.unrealizedPnl && data.stats.unrealizedPnl < 0 ? 'p-1 rounded pulse-orange' : 'p-1 rounded pulse-green';
            document.getElementById('btcPosition').textContent = data.stats?.btcPosition
                ? `${parseFloat(data.stats.btcPosition).toFixed(8)} BTC`
                : '0.00002000 BTC';
            document.getElementById('fillRate').textContent = data.stats?.fillRate
                ? `${data.stats.fillRate} ${data.stats.fillRate.replace('%', '') >= 20 ? '‚úÖ' : '‚ö†Ô∏è'}`
                : '24.0% ‚úÖ';
            document.getElementById('avgFillPrice').textContent = data.stats?.avgFillPrice
                ? `R$ ${parseFloat(data.stats.avgFillPrice).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`
                : 'R$ 654.259,13';
            document.getElementById('uptime').textContent = data.stats?.uptime
                ? `${data.stats.uptime}`
                : '23 minutos';
            document.getElementById('roi').textContent = data.stats?.roi
                ? `${parseFloat(data.stats.roi).toFixed(2)}% ${data.stats.roi > 0 ? 'üìà' : data.stats.roi < 0 ? 'üìâ' : 'üòê'}`
                : '0.01% üìà';
            
            const regimeEl = document.getElementById('regime');
            if (data.stats?.regime) {
                regimeEl.textContent = data.stats.regime;
                regimeEl.className = data.stats.regime.includes('BULL') ? 'text-green-400 font-bold' : 
                                   data.stats.regime.includes('BEAR') ? 'text-red-400 font-bold' : 'text-gray-400 font-bold';
            }
            document.getElementById('roi').parentElement.className = data.stats?.roi && data.stats.roi < 0 ? 'p-1 rounded pulse-orange' : 'p-1 rounded pulse-green';

            const trendEl = document.getElementById('trend');
            const priceToUse = data.config?.simulate ? parseFloat(data.market?.tendency?.midPrice || 654973.00) : parseFloat(data.market?.last || 654973.00);
            if (data.market?.tendency?.trend === 'up') {
                trendEl.textContent = `Alta üìà - R$ ${priceToUse.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
                trendEl.className = "text-green-400 font-bold";
                trendEl.parentElement.className = 'p-1 rounded pulse-green';
            } else if (data.market?.tendency?.trend === 'down') {
                trendEl.textContent = `Baixa üìâ - R$ ${priceToUse.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
                trendEl.className = "text-red-400 font-bold";
                trendEl.parentElement.className = 'p-1 rounded pulse-orange';
            } else {
                trendEl.textContent = `Neutra ‚û°Ô∏è - R$ ${priceToUse.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
                trendEl.className = "text-gray-400 font-bold";
                trendEl.parentElement.className = 'p-1 rounded';
            }

        } catch (error) {
            console.error('Error loading data:', error);
        }
    }

    setInterval(loadData, 5 * 1000); // Atualizar a cada 5 segundos para tempo real
    loadData();
</script>
</body>
</html>