<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MB Bot Dashboard</title>

    <!-- Tailwind CSS (modo CDN, n√£o recomendado para produ√ß√£o) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js e plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <!-- date-fns -->
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans">
<div class="container mx-auto p-4">

    <!-- Header -->
    <div class="flex justify-between items-center mb-4">
        <h1 class="text-xl sm:text-2xl font-bold">üìä MB Bot Dashboard</h1>
        <span id="mode" class="px-2 py-1 sm:px-3 sm:py-1 bg-blue-600 rounded-full text-xs sm:text-sm">Modo: --</span>
    </div>

    <!-- Cards -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <p class="text-gray-400 text-xs sm:text-sm">√öltimo Pre√ßo</p>
            <h2 id="lastPrice" class="text-lg sm:text-xl font-bold">--</h2>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <p class="text-gray-400 text-xs sm:text-sm">Spread</p>
            <h2 id="spread" class="text-lg sm:text-xl font-bold">--</h2>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <p class="text-gray-400 text-xs sm:text-sm">Volatilidade</p>
            <h2 id="volatility" class="text-lg sm:text-xl font-bold">--</h2>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <p class="text-gray-400 text-xs sm:text-sm">PnL (Total / M√™s)</p>
            <h2 id="pnl" class="text-lg sm:text-xl font-bold text-green-400">--</h2>
            <p id="monthlyPnl" class="text-xs sm:text-sm text-gray-300">Mensal: --</p>
        </div>
    </div>

    <!-- Conte√∫do principal -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Tabela de Ordens -->
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-2">Ordens Ativas</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-xs sm:text-sm">
                    <thead>
                    <tr class="text-gray-400">
                        <th class="text-left p-1 sm:p-2">Side</th>
                        <th class="text-left p-1 sm:p-2">ID</th>
                        <th class="text-left p-1 sm:p-2">Pre√ßo</th>
                        <th class="text-left p-1 sm:p-2">Qtd</th>
                        <th class="text-left p-1 sm:p-2">Status</th>
                        <th class="text-left p-1 sm:p-2">Drift</th>
                        <th class="text-left p-1 sm:p-2">Age</th>
                    </tr>
                    </thead>
                    <tbody id="ordersTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Saldos -->
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-2">Saldos</h2>
            <ul class="space-y-1 text-xs sm:text-sm">
                <li>BRL: <span id="brl">--</span></li>
                <li>BTC: <span id="btc">--</span></li>
                <li>Total: <span id="total">--</span></li>
            </ul>
        </div>
    </div>

    <!-- Gr√°ficos + Config -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-2">Evolu√ß√£o do PnL</h2>
            <div class="w-full h-64 sm:h-72">
                <canvas id="pnlChart"></canvas>
            </div>
        </div>
        <div class="bg-gray-800 p-2 sm:p-4 rounded-xl shadow">
            <h2 class="text-base sm:text-lg font-bold mb-2">Config & Tend√™ncia</h2>
            <ul class="space-y-1 text-xs sm:text-sm">
                <li>Ordem m√≠nima: <span id="orderSize">--</span></li>
                <li>Spread alvo: <span id="targetSpread">--</span></li>
                <li>Intervalo ciclo: <span id="cycleSec">--</span></li>
                <li>Tend√™ncia: <span id="trend" class="font-bold">--</span></li>
                <li>Stop-Loss: <span id="stopLoss">--</span></li>
                <li>Take-Profit: <span id="takeProfit">--</span></li>
                <li>Volume M√≠nimo: <span id="minVolume">--</span></li>
                <li>Limite de Volatilidade: <span id="volatilityLimit">--</span></li>
            </ul>
        </div>
    </div>

</div>

<script>
    const priceHistory = [];
    let pnlChart;

    // Initialize chart first
    document.addEventListener('DOMContentLoaded', () => {
        pnlChart = new Chart(document.getElementById('pnlChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: "PnL (R$)",
                        borderColor: "#4ade80",
                        backgroundColor: "rgba(74,222,128,0.2)",
                        fill: true,
                        data: [],
                        tension: 0.3,
                        pointRadius: 2,
                        yAxisID: 'y'
                    },
                    {
                        label: "BTC Price (R$)",
                        borderColor: "#60a5fa",
                        backgroundColor: "rgba(96,165,250,0.2)",
                        fill: true,
                        data: [],
                        tension: 0.3,
                        pointRadius: 2,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {legend: {display: true, position: 'top'}, tooltip: {mode: 'index', intersect: false}},
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: {display: true, text: 'PnL (R$)'},
                        ticks: {font: {size: 10}}
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        title: {display: true, text: 'BTC Price (R$)'},
                        grid: {drawOnChartArea: false},
                        ticks: {font: {size: 10}}
                    },
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            tooltipFormat: 'HH:mm:ss',
                            displayFormats: {
                                second: 'HH:mm:ss'
                            }
                        },
                        title: {display: true, text: 'Hora'},
                        ticks: {font: {size: 10}}
                    }
                }
            }
        });
    });

    function formatSpread(spread) {
        if (!spread && spread !== 0) return "Sem dados";
        const value = Number(spread).toFixed(2);
        let level = "";

        if (spread < 0.5) level = " (muito baixo)";
        else if (spread < 1.5) level = " (moderado)";
        else level = " (alto)";

        return `${value}%${level}`;
    }

    function formatVolatility(vol) {
        if (!vol && vol !== 0) return "Sem dados";
        const value = Number(vol).toFixed(2);
        let desc = "";

        if (vol < 0.5) desc = " (est√°vel)";
        else if (vol < 1.5) desc = " (moderada)";
        else desc = " (alta)";

        return `${value}%${desc}`;
    }

    async function loadData() {
        try {
            const res = await fetch('/api/status');
            const data = await res.json();

            // Safely access data fields
            const modeSpan = document.getElementById('mode');
            modeSpan.textContent = `Modo: ${data.config?.simulate ? 'Simula√ß√£o' : 'Live'}`;
            modeSpan.className = data.config?.simulate
                ? 'px-2 py-1 sm:px-3 sm:py-1 bg-yellow-600 rounded-full text-xs sm:text-sm'
                : 'px-2 py-1 sm:px-3 sm:py-1 bg-green-600 rounded-full text-xs sm:text-sm';

            // Update cards
            const lastPrice = parseFloat(data.market?.last) || 0;
            document.getElementById('lastPrice').textContent = `R$ ${lastPrice.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;

            document.getElementById('spread').textContent = formatSpread(data.market?.spread);
            document.getElementById('volatility').textContent = formatVolatility(data.market?.volatility.replace("%", ""));

            document.getElementById('pnl').textContent = `R$ ${parseFloat(data.stats?.totalPnL || 0).toFixed(2)}` +
                (data.stats?.totalPnL >= 0 ? ' üìà' : ' üìâ') || '--';
            document.getElementById('monthlyPnl').textContent = `Mensal: R$ ${parseFloat(data.stats?.monthlyPnL || 0).toFixed(2)}` || '--';

            // Update balances
            document.getElementById('brl').textContent = `R$ ${parseFloat(data.balances?.brl || 0).toFixed(2)}`;
            document.getElementById('btc').textContent = `${parseFloat(data.balances?.btc || 0).toFixed(8)} BTC`;
            document.getElementById('total').textContent = `R$ ${parseFloat(data.balances?.total || 0).toFixed(2)}`;

            // Update orders table
            const tbody = document.getElementById('ordersTable');
            tbody.innerHTML = '';
            (data.activeOrders || []).forEach(order => {
                const age = order.ageSecMinHour || {ageHour: 0, ageMin: 0, ageSec: 0};
                const ageStr = `${String(age.ageHour).padStart(2, '0')}:${String(age.ageMin % 60).padStart(2, '0')}:${String(age.ageSec % 60).padStart(2, '0')}`;
                const priceFormatted = parseFloat(order.price || 0).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="${order.side === 'buy' ? 'text-green-400' : 'text-red-400'} p-1 sm:p-2">${order.side || '--'}</td>
                    <td class="p-1 sm:p-2">${order.id || '--'}</td>
                    <td class="p-1 sm:p-2">R$ ${priceFormatted}</td>
                    <td class="p-1 sm:p-2">${parseFloat(order.qty || 0).toFixed(6)}</td>
                    <td class="p-1 sm:p-2">${order.status || '--'}</td>
                    <td class="p-1 sm:p-2">${order.drift || '--'}</td>
                    <td class="p-1 sm:p-2">${ageStr}</td>
                `;
                tbody.appendChild(tr);
            });

            // Update chart
            //atualizar gr√°fico a cada 1minuto, se n√£o ou seja a cada 6 ciclos
            // if( data.stats?.cycleCount % 6 !== 0 ) return;
            if ((pnlChart && data.stats?.pnlHistory?.length > 0 && data.stats?.pnlTimestamps?.length > 0) && data.stats?.cycles % 6 === 0) {
                if (pnlChart.data.labels.length === 0) {
                    pnlChart.data.labels = data.stats.pnlTimestamps.map(ts => new Date(ts));
                    pnlChart.data.datasets[0].data = data.stats.pnlHistory.map((val, i) => ({
                        x: new Date(data.stats.pnlTimestamps[i]),
                        y: parseFloat(val || 0)
                    }));
                    pnlChart.data.datasets[1].data = data.stats.pnlHistory.map((_, i) => ({
                        x: new Date(data.stats.pnlTimestamps[i]),
                        y: parseFloat(data.market?.last || 0)
                    }));
                } else {
                    pnlChart.data.labels.push(new Date());
                    pnlChart.data.datasets[0].data.push({x: new Date(), y: parseFloat(data.stats.totalPnL || 0)});
                    pnlChart.data.datasets[1].data.push({x: new Date(), y: parseFloat(data.market?.last || 0)});
                }

                if (pnlChart.data.labels.length > 1440) { //atualizados a cada 10s, manter 1440 = 4h
                    pnlChart.data.labels.shift();
                    pnlChart.data.datasets[0].data.shift();
                    pnlChart.data.datasets[1].data.shift();
                }
                pnlChart.update();
            }

            // Update config & trend
            document.getElementById('orderSize').textContent = data.config?.orderSize
                ? `${data.config.orderSize} BTC (~R$ ${(data.config.orderSize * (data.market?.last || 0)).toFixed(2)})`
                : '--';
            document.getElementById('targetSpread').textContent = data.config?.spreadPct || '--';
            document.getElementById('cycleSec').textContent = `${data.config?.cycleSec || '--'}s`;

            priceHistory.push(data.market?.last || 0);
            if (priceHistory.length > 20) priceHistory.shift();

            const trendEl = document.getElementById('trend');
            if (data.market?.tendency.trend === 'up') {
                const valorRef = Number(data.market?.bid) || 0;
                trendEl.textContent = "Alta üìà - " + `R$ ${valorRef.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
                trendEl.className = "text-green-400 font-bold";
            } else if (data.market?.tendency.trend === 'down') {
                const valorRef = Number(data.market?.ask) || 0;
                trendEl.textContent = "Baixa üìâ - " + `R$ ${valorRef.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
                trendEl.className = "text-red-400 font-bold";
            } else {
                const valorRef = Number(data.market?.mid) || 0;
                trendEl.textContent = "Neutra ‚û°Ô∏è - " + `R$ ${valorRef.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
                trendEl.className = "text-gray-400 font-bold";
            }

            document.getElementById('stopLoss').textContent = data.config?.stopLoss ? `${data.config.stopLoss}%` : 'N/A';
            document.getElementById('takeProfit').textContent = data.config?.takeProfit ? `${data.config.takeProfit}%` : 'N/A';
            document.getElementById('minVolume').textContent = data.config?.minVolume ? `${data.config.minVolume} BTC` : 'N/A';
            document.getElementById('volatilityLimit').textContent = data.config?.volatilityLimit ? `${data.config.volatilityLimit}%` : 'N/A';
        } catch (error) {
            console.error('Error loading data:', error);
        }
    }

    setInterval(loadData, 10 * 1000);
    loadData();
</script>
</body>
</html>